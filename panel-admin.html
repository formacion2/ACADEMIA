<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Geincos Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;700&display=swap');
        :root { 
            --bg-light: #eef2ff; --bg-white: #ffffff; --text-dark: #1e1b4b; --text-gray: #64748b;     
            --primary: #4f46e5; --primary-hover: #4338ca; --accent: #8b5cf6;        
            --danger: #ef4444; --success: #10b981; --warning: #f59e0b; --border: #c7d2fe; --shadow: rgba(79, 70, 229, 0.15);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background-color: var(--bg-light); color: var(--text-dark); display: flex; min-height: 100vh; overflow-x: hidden; }
        
        .sidebar { width: 260px; background: var(--bg-white); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; position: fixed; height: 100%; z-index: 100; box-shadow: 4px 0 20px var(--shadow); }
        .brand { text-align: center; margin-bottom: 40px; } .brand img { width: 150px; height: auto; }
        .menu-item { display: flex; align-items: center; padding: 15px 20px; color: var(--text-gray); cursor: pointer; border-radius: 12px; margin-bottom: 10px; transition: 0.3s; font-weight: 600; }
        .menu-item:hover, .menu-item.active { background-color: #e0e7ff; color: var(--primary); }
        .menu-item i { margin-right: 15px; width: 20px; text-align: center; color: var(--accent); }
        .main-content { flex: 1; margin-left: 260px; padding: 30px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 2px solid var(--border); padding-bottom: 20px; }
        h2 { color: var(--text-dark); font-weight: 800; letter-spacing: -0.5px; }
        .btn-action { padding: 12px 24px; border-radius: 10px; border: none; cursor: pointer; font-weight: 600; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; box-shadow: 0 4px 6px var(--shadow); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; } .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 12px var(--shadow); }
        .btn-success { background: var(--success); color: white; }
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; margin-bottom: 30px; }
        .card { background: var(--bg-white); padding: 25px; border-radius: 20px; border: 1px solid var(--border); box-shadow: 0 10px 15px -3px var(--shadow); transition: transform 0.3s; }
        .card:hover { transform: translateY(-5px); }
        .card h3 { font-size: 0.9rem; color: var(--text-gray); margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; } 
        .card .number { font-size: 3rem; font-weight: 800; color: var(--primary); }
        .table-box { background: var(--bg-white); padding: 25px; border-radius: 20px; border: 1px solid var(--border); overflow-x: auto; box-shadow: 0 10px 15px -3px var(--shadow); }
        .box-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        table { width: 100%; border-collapse: separate; border-spacing: 0 10px; } 
        th { text-align: left; padding: 15px; color: var(--text-gray); font-weight: 700; text-transform: uppercase; font-size: 0.8rem; }
        td { padding: 15px; background: #f8fafc; border-top: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0; }
        td:first-child { border-left: 1px solid #e2e8f0; border-top-left-radius: 10px; border-bottom-left-radius: 10px; font-weight: 600; color: var(--text-dark); }
        td:last-child { border-right: 1px solid #e2e8f0; border-top-right-radius: 10px; border-bottom-right-radius: 10px; }
        .action-icons i { cursor: pointer; margin-right: 12px; font-size: 1.2rem; transition: 0.2s; color: #94a3b8; }
        .fa-edit:hover { color: var(--primary); transform: scale(1.2); } .fa-trash:hover { color: var(--danger); transform: scale(1.2); }
        .form-control { width: 100%; background: #f8fafc; border: 2px solid #e2e8f0; padding: 12px; border-radius: 10px; color: #333; margin-bottom: 15px; outline: none; transition: 0.3s; font-size: 1rem; }
        .form-control:focus { border-color: var(--primary); background: #fff; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); }
        .content-section { display: none; animation: fadeIn 0.3s ease; } .content-section.active { display: block; } @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .progress-bg { width: 100px; height: 10px; background: #e2e8f0; border-radius: 10px; display: inline-block; margin-right: 10px; vertical-align: middle; } 
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--accent)); border-radius: 10px; }
        .badge { padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; background: #dcfce7; color: var(--success); font-weight: 700; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); z-index: 1000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-box { background: var(--bg-white); width: 500px; max-width: 90%; padding: 30px; border-radius: 20px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); position: relative; max-height: 90vh; overflow-y: auto; }
        .close-modal { float: right; font-size: 1.8rem; cursor: pointer; color: #94a3b8; transition: 0.2s; } .close-modal:hover { color: var(--danger); }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="brand"><img src="geincos.png" alt="Admin"></div>
        <div class="menu-item active" onclick="nav('dashboard', this)"><i class="fas fa-chart-line"></i> Dashboard</div>
        <div class="menu-item" onclick="nav('users', this); loadUsers()"><i class="fas fa-users"></i> Usuarios</div>
        <div class="menu-item" onclick="nav('courses', this); loadCourses()"><i class="fas fa-graduation-cap"></i> Cursos</div>
        <div class="menu-item" onclick="nav('exams', this); loadCoursesSelect()"><i class="fas fa-clipboard-check"></i> Evaluaciones</div>
    </div>
    <div class="main-content">
        <div class="header">
            <h2 id="pageTitle">DASHBOARD</h2>
            <button class="btn-action btn-danger" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Salir</button>
        </div>
        <div id="dashboard" class="content-section active">
            <div class="cards-grid">
                <div class="card" style="border-left: 5px solid var(--primary);"><h3>Total Usuarios</h3><div class="number" id="dUsers">--</div></div>
                <div class="card" style="border-left: 5px solid var(--success);"><h3>Promedio Global</h3><div class="number" id="dAvg">--</div></div>
                <div class="card" style="border-left: 5px solid var(--warning);"><h3>Cursos Activos</h3><div class="number" id="dCourses">--</div></div>
            </div>
            <center><button class="btn-action btn-primary" onclick="loadUsers(); loadCourses()">游댃 Actualizar Datos</button></center>
        </div>
        <div id="users" class="content-section">
            <div class="table-box">
                <div class="box-header"><h3>Gesti칩n de Usuarios</h3><button class="btn-action btn-success" onclick="downloadExcel()"><i class="fas fa-file-excel"></i> Reporte</button></div>
                <table><thead><tr><th>Usuario</th><th>DNI</th><th>Rol</th><th>Progreso</th><th>Promedio</th><th>Acciones</th></tr></thead><tbody id="tbodyUsers"></tbody></table>
            </div>
        </div>
        <div id="courses" class="content-section">
            <div class="table-box">
                <div class="box-header"><h3>Mis Cursos</h3><button class="btn-action btn-primary" onclick="openModal('modalCourse')"><i class="fas fa-plus"></i> Nuevo Curso</button></div>
                <table><thead><tr><th>T칤tulo</th><th>Categor칤a</th><th>Video</th><th>Acciones</th></tr></thead><tbody id="tbodyCourses"></tbody></table>
            </div>
        </div>
        
        <div id="exams" class="content-section">
            <div class="table-box">
                <h3>Gesti칩n de Preguntas</h3>
                <p style="color:#94a3b8; margin-bottom:15px">Selecciona un curso para ver sus preguntas.</p>
                <div style="margin: 20px 0; display: flex; gap: 10px;">
                    <select id="selectCourseExam" class="form-control" style="max-width: 300px; margin:0;" onchange="loadQuestionsForCourse()">
                        <option value="">1. Selecciona un curso...</option>
                    </select>
                    <button class="btn-action btn-primary" onclick="openQuestionModal()">+ Nueva Pregunta</button>
                </div>
                <table id="tableQuestions">
                    <thead><tr><th>Pregunta</th><th>Respuesta Correcta</th><th>Acciones</th></tr></thead>
                    <tbody id="tbodyQuestions">
                        <tr><td colspan="3" style="text-align:center; color:#94a3b8;">Selecciona un curso arriba para ver sus preguntas.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="modalUser"><div class="modal-box"><span class="close-modal" onclick="closeModals()">&times;</span><h3>Editar Usuario</h3><br><input type="hidden" id="uUserOrigin"><label style="color:#666">DNI</label><input type="text" id="uDNI" class="form-control"><label style="color:#666">Nueva Contrase침a</label><input type="password" id="uPass" class="form-control" placeholder="Dejar vac칤o si no cambia"><button class="btn-action btn-success" style="width:100%" onclick="saveUserEdit()">Guardar Cambios</button></div></div>
    <div class="modal-overlay" id="modalCourse"><div class="modal-box"><span class="close-modal" onclick="closeModals()">&times;</span><h3 id="courseModalTitle">Nuevo Curso</h3><br><input type="hidden" id="cMode" value="create"><input type="hidden" id="cTitleOrigin"><input type="text" id="cTitle" class="form-control" placeholder="T칤tulo"><input type="text" id="cDesc" class="form-control" placeholder="Descripci칩n"><input type="text" id="cVideo" class="form-control" placeholder="Link Youtube"><select id="cCat" class="form-control"><option>BANCO</option><option>AUNA</option><option>COBRANZAS</option></select><button class="btn-action btn-primary" style="width:100%" onclick="saveCourse()">Guardar Curso</button></div></div>
    <div class="modal-overlay" id="modalQuestion"><div class="modal-box"><span class="close-modal" onclick="closeModals()">&times;</span><h3>Nueva Pregunta</h3><br><input type="text" id="qText" class="form-control" placeholder="Escribe la pregunta"><input type="text" id="qOp1" class="form-control" placeholder="Opci칩n A" style="border-left: 3px solid #ef4444"><input type="text" id="qOp2" class="form-control" placeholder="Opci칩n B" style="border-left: 3px solid #3b82f6"><input type="text" id="qOp3" class="form-control" placeholder="Opci칩n C" style="border-left: 3px solid #f59e0b"><label style="color:#666">Opci칩n Correcta:</label><select id="qCorrect" class="form-control"><option value="op1">Opci칩n A</option><option value="op2">Opci칩n B</option><option value="op3">Opci칩n C</option></select><button class="btn-action btn-success" style="width:100%" onclick="saveQuestion()">Guardar Pregunta</button></div></div>

    <script>
        // TU URL:
        const API_URL = 'https://script.google.com/macros/s/AKfycbx4WFS3Gndn-6T6_ikhb3sbLyVNnwpHjBtq82uDYWlbdiom2PCOzTqCp6-mSDcy0YgNPg/exec';
        
        function nav(id, el) { document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active')); el.classList.add('active'); document.getElementById('pageTitle').innerText = id.toUpperCase(); }
        function closeModals() { document.querySelectorAll('.modal-overlay').forEach(m => m.style.display='none'); }
        function openModal(id) { document.getElementById(id).style.display='flex'; }
        function logout() { if(confirm("쯉alir?")) { localStorage.removeItem('usuarioActual'); window.location.href = 'index.html'; } }
        function post(a, d, c) { let f = new FormData(); f.append('action', a); for(let k in d) f.append(k, d[k]); fetch(API_URL, {method:'POST', body:f}).then(r=>r.json()).then(res=>{ if(res.result==='success')c(res); else alert(res.message); }); }

        function loadUsers() { post('readUsers', {}, data => { document.getElementById('dUsers').innerText = data.data.length; let html = ''; data.data.forEach(u => { if(u.rol !== 'admin') { html += `<tr><td>${u.usuario}</td><td>${u.dni}</td><td>${u.rol}</td><td><div class="progress-bg"><div class="progress-fill" style="width:${Math.min(u.cursos*10,100)}%"></div></div></td><td>${u.promedio}</td><td class="action-icons"><i class="fas fa-edit" onclick="editUser('${u.usuario}', '${u.dni}')"></i><i class="fas fa-trash" onclick="deleteUser('${u.usuario}')"></i></td></tr>`; } }); document.getElementById('tbodyUsers').innerHTML = html; }); }
        function editUser(user, dni) { document.getElementById('uUserOrigin').value = user; document.getElementById('uDNI').value = dni; document.getElementById('uPass').value = ""; openModal('modalUser'); }
        function saveUserEdit() { let u = document.getElementById('uUserOrigin').value; let d = document.getElementById('uDNI').value; let p = document.getElementById('uPass').value; post('editUser', {UsuarioOriginal: u, NuevoDNI: d, NuevoPass: p}, res => { alert("Actualizado"); closeModals(); loadUsers(); }); }
        function deleteUser(user) { if(confirm("쮼liminar usuario?")) { post('deleteUser', {Usuario: user}, res => { loadUsers(); }); } }
        function downloadExcel() { post('getFullReport', {}, res => { let csv = "data:text/csv;charset=utf-8,Nombre,DNI,Correo,Progreso,Promedio,Detalles\n"; res.data.forEach(r => { let det = r.detalles.map(d => `[${d.c}: ${d.n}]`).join(" | "); csv += `${r.usuario},${r.dni},${r.correo},${r.progreso},${r.promedio},"${det}"\n`; }); let link = document.createElement("a"); link.href = encodeURI(csv); link.download = "Reporte.csv"; link.click(); }); }
        
        function loadCourses() { post('readCourses', {}, data => { document.getElementById('dCourses').innerText = data.data.length; let html = ''; data.data.forEach(c => { html += `<tr><td>${c.titulo}</td><td><span class="badge">${c.categoria}</span></td><td style="font-size:0.8rem; color:#4f46e5">${c.video}</td><td class="action-icons"><i class="fas fa-edit" onclick="prepareEditCourse('${c.titulo}', '${c.descripcion}', '${c.video}', '${c.categoria}')"></i><i class="fas fa-trash" onclick="deleteCourse('${c.titulo}')"></i></td></tr>`; }); document.getElementById('tbodyCourses').innerHTML = html; }); }
        function prepareEditCourse(t, d, v, c) { document.getElementById('cMode').value = 'edit'; document.getElementById('cTitleOrigin').value = t; document.getElementById('cTitle').value = t; document.getElementById('cDesc').value = d; document.getElementById('cVideo').value = v; document.getElementById('cCat').value = c; document.getElementById('courseModalTitle').innerText = "Editar Curso"; openModal('modalCourse'); }
        function saveCourse() { let mode = document.getElementById('cMode').value; let link = cleanLink(document.getElementById('cVideo').value); if(!link) return alert("Link inv치lido"); let data = { Titulo: document.getElementById('cTitle').value, Descripcion: document.getElementById('cDesc').value, Video: link, Categoria: document.getElementById('cCat').value }; if(mode === 'create') { post('saveCourse', data, res => { alert("Creado"); closeModals(); loadCourses(); }); } else { data.TituloOriginal = document.getElementById('cTitleOrigin').value; post('editCourse', data, res => { alert("Actualizado"); closeModals(); loadCourses(); }); } }
        function deleteCourse(title) { if(confirm("쮼liminar curso?")) { post('deleteCourse', {Titulo: title}, res => { loadCourses(); }); } }
        
        function loadCoursesSelect() { 
            post('readCourses', {}, data => { 
                let sel = document.getElementById('selectCourseExam'); 
                sel.innerHTML = '<option value="">Selecciona un curso...</option>'; 
                data.data.forEach(c => { 
                    let opt = document.createElement('option'); 
                    opt.value = c.titulo; 
                    opt.innerText = c.titulo; 
                    sel.appendChild(opt); 
                }); 
            }); 
        }

        function loadQuestionsForCourse() { 
            let curso = document.getElementById('selectCourseExam').value; 
            let tbody = document.getElementById('tbodyQuestions');
            
            if(!curso) { 
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">Selecciona un curso.</td></tr>'; 
                return; 
            } 
            
            tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">Cargando preguntas...</td></tr>';

            post('getExam', {Curso: curso}, data => { 
                let html = ''; 
                if(data.data.length === 0) {
                    html = '<tr><td colspan="3" style="text-align:center; color:#f59e0b;">Este curso no tiene preguntas a칰n. 춰Crea una!</td></tr>';
                } else {
                    data.data.forEach(q => { 
                        html += `<tr>
                            <td>${q.pregunta}</td>
                            <td style="color:var(--success); font-weight:bold;">${q.correcta}</td>
                            <td class="action-icons"><i class="fas fa-trash" onclick="deleteQuestion('${curso}', '${q.pregunta}')"></i></td>
                        </tr>`; 
                    }); 
                }
                tbody.innerHTML = html; 
            }); 
        }

        function openQuestionModal() { 
            if(!document.getElementById('selectCourseExam').value) return alert("Primero selecciona un curso de la lista."); 
            openModal('modalQuestion'); 
        }
        
        function saveQuestion() { 
            let op1 = document.getElementById('qOp1').value; 
            let op2 = document.getElementById('qOp2').value; 
            let op3 = document.getElementById('qOp3').value; 
            let sel = document.getElementById('qCorrect').value; 
            let correcta = (sel=='op1')?op1:(sel=='op2')?op2:op3; 
            
            let data = { 
                Curso: document.getElementById('selectCourseExam').value, 
                Pregunta: document.getElementById('qText').value, 
                Op1: op1, Op2: op2, Op3: op3, Correcta: correcta 
            }; 
            
            post('saveQuestion', data, res => { 
                alert("Pregunta Guardada"); 
                closeModals(); 
                loadQuestionsForCourse(); 
                // Limpiar formulario
                document.getElementById('qText').value="";
                document.getElementById('qOp1').value="";
                document.getElementById('qOp2').value="";
                document.getElementById('qOp3').value="";
            }); 
        }
        
        function deleteQuestion(curso, preg) { 
            if(confirm("쮹orrar pregunta?")) { 
                post('deleteQuestion', {Curso: curso, Pregunta: preg}, res => { 
                    loadQuestionsForCourse(); 
                }); 
            } 
        }

        function cleanLink(url) { var match = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/); return (match && match[2].length == 11) ? "https://www.youtube.com/embed/" + match[2] : null; }
    </script>
</body>
</html>