<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geincos Admin - Gesti칩n Total</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap');
        :root { --bg-dark: #0f172a; --bg-panel: #1e293b; --text-main: #f1f5f9; --text-muted: #94a3b8; --accent-blue: #3b82f6; --accent-green: #10b981; --accent-orange: #f59e0b; --danger: #ef4444; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background-color: var(--bg-dark); color: var(--text-main); display: flex; min-height: 100vh; overflow-x: hidden; }
        
        /* Sidebar */
        .sidebar { width: 260px; background-color: var(--bg-dark); border-right: 1px solid #334155; display: flex; flex-direction: column; padding: 20px; position: fixed; height: 100%; z-index: 10; }
        .brand { font-size: 1.5rem; font-weight: 700; color: #818cf8; margin-bottom: 40px; text-transform: uppercase; letter-spacing: 1px; text-align: center; }
        .menu-item { display: flex; align-items: center; padding: 15px 20px; color: var(--text-muted); text-decoration: none; border-radius: 12px; margin-bottom: 10px; transition: all 0.3s ease; cursor: pointer; }
        .menu-item:hover, .menu-item.active { background-color: #1e293b; color: var(--text-main); border-left: 4px solid var(--accent-blue); }
        
        /* Contenido */
        .main-content { flex: 1; margin-left: 260px; padding: 30px; background-color: var(--bg-dark); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .btn-logout { background: var(--danger); color: white; padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; transition: 0.3s; font-weight: 600;}
        .btn-logout:hover { background: #dc2626; }
        
        /* Cards y Tablas */
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .card { background: var(--bg-panel); padding: 25px; border-radius: 16px; border: 1px solid #334155; }
        .card h3 { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 10px; }
        .card .number { font-size: 2.5rem; font-weight: 700; }
        .card.blue { border-left: 5px solid var(--accent-blue); }

        .table-container { background: var(--bg-panel); padding: 25px; border-radius: 16px; border: 1px solid #334155; margin-bottom: 30px; }
        .btn-add { background: var(--accent-blue); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; width: 100%; margin-top: 10px; font-weight: 600; transition: 0.3s; }
        .btn-add:hover { background: #2563eb; }
        
        .form-control { width: 100%; background: #0f172a; border: 1px solid #334155; padding: 12px; border-radius: 8px; color: white; margin-bottom: 15px; }
        .content-section { display: none; animation: fadeIn 0.4s ease; }
        .content-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; padding: 15px; color: var(--text-muted); border-bottom: 1px solid #334155; }
        td { padding: 15px; border-bottom: 1px solid #334155; color: #e2e8f0; }
        .badge { padding: 5px 10px; border-radius: 20px; font-size: 0.75rem; background: rgba(16, 185, 129, 0.2); color: var(--accent-green); }
        
        /* Progress bar simple */
        .progress-bg { width: 80px; height: 6px; background: #334155; border-radius: 10px; display: inline-block; margin-right: 10px; vertical-align: middle; }
        .progress-fill { height: 100%; background: var(--accent-blue); border-radius: 10px; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="brand">GEINCOS ADMIN</div>
        <div class="menu-item active" onclick="showSection('dashboard', this)"><i class="fas fa-th-large"></i> Dashboard</div>
        <div class="menu-item" onclick="showSection('usuarios', this); cargarUsuarios()"><i class="fas fa-users"></i> Usuarios y Avance</div>
        <div class="menu-item" onclick="showSection('cursos', this); cargarCursos()"><i class="fas fa-graduation-cap"></i> Gesti칩n de Cursos</div>
        <div class="menu-item" onclick="showSection('evaluaciones', this); cargarSelectorCursos()"><i class="fas fa-edit"></i> Crear Evaluaciones</div>
    </div>

    <div class="main-content">
        <div class="header">
            <h2 id="page-title">DASHBOARD</h2>
            <button class="btn-logout" onclick="cerrarSesion()"><i class="fas fa-sign-out-alt"></i> Cerrar Sesi칩n</button>
        </div>

        <div id="dashboard" class="content-section active">
            <div class="cards-grid">
                <div class="card blue"><h3>Total Usuarios</h3><div class="number" id="dashUsers">--</div></div>
                <div class="card blue" style="border-left-color: #10b981;"><h3>Promedio Global</h3><div class="number" id="dashPromedio">--</div></div>
                <div class="card blue" style="border-left-color: #f59e0b;"><h3>Cursos</h3><div class="number" id="dashCursos">--</div></div>
            </div>
            <div style="text-align: center;"><button class="btn-add" style="width:auto" onclick="cargarUsuarios(); cargarCursos();">游댃 Actualizar M칠tricas</button></div>
        </div>

        <div id="usuarios" class="content-section">
            <div class="table-container">
                <h3>Avance de Alumnos</h3>
                <table id="tablaUsuarios">
                    <thead><tr><th>Usuario</th><th>Progreso</th><th>Promedio</th><th>Estado</th></tr></thead>
                    <tbody id="tablaUsuariosBody"></tbody>
                </table>
            </div>
        </div>

        <div id="cursos" class="content-section">
            <div class="table-container">
                <h3>Crear Curso</h3>
                <form id="formCursos">
                    <input type="text" id="txtTitulo" class="form-control" placeholder="T칤tulo">
                    <input type="text" id="txtDesc" class="form-control" placeholder="Descripci칩n">
                    <input type="text" id="txtVideo" class="form-control" placeholder="Link Youtube (Cualquier formato)">
                    <select id="txtCat" class="form-control"><option>BANCO</option><option>AUNA</option><option>COBRANZAS</option></select>
                    <button type="button" class="btn-add" onclick="guardarCurso()">Guardar Curso</button>
                </form>
            </div>
            <div class="table-container">
                <h3>Cursos Actuales</h3>
                <table><thead><tr><th>T칤tulo</th><th>Categor칤a</th><th>Video</th></tr></thead><tbody id="tablaCursosBody"></tbody></table>
            </div>
        </div>

        <div id="evaluaciones" class="content-section">
            <div class="table-container">
                <h3>游닇 Creador de Ex치menes</h3>
                <p style="color:#94a3b8; margin-bottom:15px">Selecciona un curso y a침ade preguntas.</p>
                <form id="formPreguntas">
                    <label style="color:#fff">1. Selecciona el Curso:</label>
                    <select id="selectCursoEval" class="form-control"><option>Cargando cursos...</option></select>

                    <label style="color:#fff">2. Escribe la Pregunta:</label>
                    <input type="text" id="txtPregunta" class="form-control" placeholder="Ej: 쯈u칠 es la venta cruzada?">

                    <label style="color:#fff">3. Define las Opciones:</label>
                    <input type="text" id="txtOp1" class="form-control" placeholder="Opci칩n A" style="border-left: 3px solid #ef4444">
                    <input type="text" id="txtOp2" class="form-control" placeholder="Opci칩n B" style="border-left: 3px solid #3b82f6">
                    <input type="text" id="txtOp3" class="form-control" placeholder="Opci칩n C" style="border-left: 3px solid #f59e0b">

                    <label style="color:#fff">4. 쮺u치l es la Correcta?</label>
                    <select id="selectCorrecta" class="form-control">
                        <option value="op1">Opci칩n A</option>
                        <option value="op2">Opci칩n B</option>
                        <option value="op3">Opci칩n C</option>
                    </select>
                    <button type="button" class="btn-add" onclick="guardarPregunta()">游 A침adir Pregunta</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // URL DE GOOGLE APPS SCRIPT
        const scriptURL = 'https://script.google.com/macros/s/AKfycbzJY64n5--1k8c0gnhbSrk4kmFl4KR9T4V_ElPJH2BE7RQY5A9kJB2zyqk-WDzMMRLpTw/exec';

        function showSection(id, el) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
            if(el) el.classList.add('active');
            document.getElementById('page-title').innerText = id.toUpperCase();
        }

        // --- LOGOUT (CORREGIDO) ---
        function cerrarSesion() {
            if(confirm("쯉eguro que deseas salir?")) {
                localStorage.removeItem('usuarioActual'); // Borra sesi칩n
                window.location.href = 'index.html'; // Redirige
            }
        }

        // --- PREGUNTAS ---
        function cargarSelectorCursos() {
            const select = document.getElementById('selectCursoEval');
            select.innerHTML = '<option>Cargando...</option>';
            let formData = new FormData(); formData.append('action', 'readCourses');
            fetch(scriptURL, { method: 'POST', body: formData }).then(r => r.json()).then(data => {
                select.innerHTML = '';
                data.data.forEach(c => {
                    let opt = document.createElement('option'); opt.value = c.titulo; opt.innerText = c.titulo; select.appendChild(opt);
                });
            });
        }

        function guardarPregunta() {
            const btn = document.querySelector('#formPreguntas button');
            const op1 = document.getElementById('txtOp1').value;
            const op2 = document.getElementById('txtOp2').value;
            const op3 = document.getElementById('txtOp3').value;
            const correctaVal = document.getElementById('selectCorrecta').value;
            let textoCorrecta = (correctaVal === 'op1') ? op1 : (correctaVal === 'op2') ? op2 : op3;

            btn.innerText = "Guardando..."; btn.disabled = true;
            let formData = new FormData();
            formData.append('action', 'saveQuestion');
            formData.append('Curso', document.getElementById('selectCursoEval').value);
            formData.append('Pregunta', document.getElementById('txtPregunta').value);
            formData.append('Op1', op1); formData.append('Op2', op2); formData.append('Op3', op3);
            formData.append('Correcta', textoCorrecta);

            fetch(scriptURL, { method: 'POST', body: formData }).then(r => r.json()).then(d => {
                alert("춰Pregunta Agregada!");
                document.getElementById('txtPregunta').value = "";
                document.getElementById('txtOp1').value = "";
                document.getElementById('txtOp2').value = "";
                document.getElementById('txtOp3').value = "";
                btn.innerText = "游 A침adir Pregunta"; btn.disabled = false;
            });
        }

        // --- CURSOS ---
        function limpiarLinkYoutube(url) {
            var regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            var match = url.match(regExp);
            return (match && match[2].length == 11) ? "https://www.youtube.com/embed/" + match[2] : null;
        }

        function guardarCurso() {
            const linkLimpio = limpiarLinkYoutube(document.getElementById('txtVideo').value);
            if (!linkLimpio) { alert("Link inv치lido"); return; }
            let formData = new FormData();
            formData.append('action', 'saveCourse');
            formData.append('Titulo', document.getElementById('txtTitulo').value);
            formData.append('Descripcion', document.getElementById('txtDesc').value);
            formData.append('Video', linkLimpio);
            formData.append('Categoria', document.getElementById('txtCat').value);
            fetch(scriptURL, { method: 'POST', body: formData }).then(() => { alert("Curso Guardado"); cargarCursos(); });
        }

        // --- CARGA DE DATOS ---
        function cargarUsuarios() {
             let formData = new FormData(); formData.append('action', 'readUsers');
             fetch(scriptURL, {method:'POST', body:formData}).then(r=>r.json()).then(d=>{
                 document.getElementById('dashUsers').innerText = d.data.length;
                 let tbody = document.getElementById('tablaUsuariosBody'); tbody.innerHTML = '';
                 d.data.forEach(u => { 
                     if(u.rol !== 'admin') {
                        let width = u.cursos * 10; if(width>100) width=100;
                        tbody.innerHTML += `<tr>
                            <td>${u.usuario}</td>
                            <td><div class="progress-bg"><div class="progress-fill" style="width:${width}%"></div></div> ${u.cursos}</td>
                            <td>${u.promedio}</td>
                            <td><span class="badge">Activo</span></td>
                        </tr>`;
                     }
                 });
             });
        }
        function cargarCursos() {
             let formData = new FormData(); formData.append('action', 'readCourses');
             fetch(scriptURL, {method:'POST', body:formData}).then(r=>r.json()).then(d=>{
                 document.getElementById('dashCursos').innerText = d.data.length;
                 let tbody = document.getElementById('tablaCursosBody'); tbody.innerHTML = '';
                 d.data.forEach(c => tbody.innerHTML += `<tr><td>${c.titulo}</td><td>${c.categoria}</td><td style="font-size:0.8rem; color:#3b82f6">${c.video}</td></tr>`);
             });
        }
    </script>
</body>
</html>