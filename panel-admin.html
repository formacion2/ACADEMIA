<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Geincos Admin - Master Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;700&display=swap');
        :root { --bg-light: #eef2ff; --bg-white: #ffffff; --text-dark: #1e1b4b; --text-gray: #64748b; --accent: #4f46e5; --accent-hover: #4338ca; --danger: #ef4444; --success: #10b981; --warning: #f59e0b; --border: #c7d2fe; --shadow: rgba(79, 70, 229, 0.15); }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background-color: var(--bg-light); color: var(--text-dark); display: flex; min-height: 100vh; overflow-x: hidden; }
        
        .sidebar { width: 260px; background: var(--bg-white); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; position: fixed; height: 100%; z-index: 100; box-shadow: 4px 0 20px var(--shadow); }
        .brand { text-align: center; margin-bottom: 40px; } .brand img { width: 150px; height: auto; }
        .menu-item { display: flex; align-items: center; padding: 15px 20px; color: var(--text-gray); cursor: pointer; border-radius: 12px; margin-bottom: 10px; transition: 0.3s; font-weight: 600; }
        .menu-item:hover, .menu-item.active { background-color: #e0e7ff; color: var(--accent); border-left: 4px solid var(--accent); }
        .menu-item i { margin-right: 15px; width: 20px; text-align: center; color: var(--accent); }
        .main-content { flex: 1; margin-left: 260px; padding: 30px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 2px solid var(--border); padding-bottom: 20px; }
        .btn-action { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; transition:0.2s;}
        .btn-danger { background: var(--danger); color: white; } .btn-primary { background: var(--accent); color: white; } .btn-success { background: var(--success); color: white; }
        
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: var(--bg-white); padding: 25px; border-radius: 20px; border: 1px solid var(--border); box-shadow: 0 10px 15px -3px var(--shadow); }
        .card h3 { font-size: 0.9rem; color: var(--text-gray); margin-bottom: 5px; text-transform: uppercase; } .card .number { font-size: 3rem; font-weight: 800; color: var(--accent); }
        
        .table-box { background: var(--bg-white); padding: 25px; border-radius: 20px; border: 1px solid var(--border); overflow-x: auto; box-shadow: 0 10px 15px -3px var(--shadow); }
        table { width: 100%; border-collapse: separate; border-spacing: 0 10px; } 
        th { text-align: left; padding: 15px; color: var(--text-gray); font-weight: 700; text-transform: uppercase; font-size: 0.8rem; }
        td { padding: 15px; background: #f8fafc; border-top: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0; }
        td:first-child { border-left: 1px solid #e2e8f0; border-top-left-radius: 10px; border-bottom-left-radius: 10px; font-weight: 700; }
        td:last-child { border-right: 1px solid #e2e8f0; border-top-right-radius: 10px; border-bottom-right-radius: 10px; }
        
        .details-row { display: none; background: #f1f5f9; }
        .details-content { padding: 20px; border-radius: 10px; margin: 10px; background: white; border: 1px solid var(--border); }
        .rank-Badge { background: #fef3c7; color: #d97706; padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; display: inline-flex; align-items: center; gap: 5px; }
        
        .form-control { width: 100%; background: #f8fafc; border: 2px solid #e2e8f0; padding: 12px; border-radius: 10px; margin-bottom: 15px; outline: none; } .form-control:focus { border-color: var(--accent); }
        .content-section { display: none; animation: fadeIn 0.3s ease; } .content-section.active { display: block; } @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal-box { background: var(--bg-white); width: 500px; max-width: 90%; padding: 30px; border-radius: 20px; position: relative; max-height: 90vh; overflow-y: auto; }
        .close-modal { float: right; font-size: 1.5rem; cursor: pointer; color: #94a3b8; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="brand"><img src="geincos.png" alt="Admin"></div>
        <div class="menu-item active" onclick="nav('dashboard', this)"><i class="fas fa-chart-line"></i> Dashboard</div>
        <div class="menu-item" onclick="nav('users', this); loadUsers()"><i class="fas fa-users"></i> Usuarios y Ranking</div>
        <div class="menu-item" onclick="nav('courses', this); loadCourses()"><i class="fas fa-graduation-cap"></i> Cursos y M贸dulos</div>
        <div class="menu-item" onclick="nav('exams', this); loadCoursesSelect()"><i class="fas fa-clipboard-check"></i> Evaluaciones</div>
    </div>
    <div class="main-content">
        <div class="header">
            <h2 id="pageTitle">DASHBOARD</h2>
            <button class="btn-action btn-danger" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Salir</button>
        </div>

        <div id="dashboard" class="content-section active">
            <div class="cards-grid">
                <div class="card"><h3>Usuarios</h3><div class="number" id="dUsers">--</div></div>
                <div class="card"><h3>Cursos</h3><div class="number" id="dCourses">--</div></div>
            </div>
            <div class="table-box" style="margin-top:20px;">
                <h3> Ranking por Grupos (Top 3)</h3>
                <div id="rankingContainer">Cargando rankings...</div>
            </div>
        </div>

        <div id="users" class="content-section">
            <div class="table-box">
                <div class="box-header"><h3>Gesti贸n de Alumnos</h3><button class="btn-action btn-success" onclick="downloadExcel()"><i class="fas fa-file-excel"></i> Reporte</button></div>
                <table><thead><tr><th>Usuario</th><th>Grupo (Etiqueta)</th><th>Promedio</th><th>Acciones</th></tr></thead><tbody id="tbodyUsers"></tbody></table>
            </div>
        </div>

        <div id="courses" class="content-section">
            <div class="table-box">
                <div class="box-header"><h3>Biblioteca de Contenido</h3><button class="btn-action btn-primary" onclick="openModal('modalCourse')"><i class="fas fa-plus"></i> Nuevo Material</button></div>
                <table><thead><tr><th>M贸dulo</th><th>T铆tulo</th><th>Categor铆a</th><th>Acciones</th></tr></thead><tbody id="tbodyCourses"></tbody></table>
            </div>
        </div>

        <div id="exams" class="content-section">
            <div class="table-box">
                <h3>Editor de Ex谩menes</h3>
                <div style="margin: 20px 0; display: flex; gap: 10px;">
                    <select id="selectCourseExam" class="form-control" style="max-width: 300px; margin:0;" onchange="loadQuestionsForCourse()"><option value="">Selecciona curso...</option></select>
                    <button class="btn-action btn-primary" onclick="openQuestionModal()">+ Nueva Pregunta</button>
                </div>
                <table id="tableQuestions" style="display:none"><thead><tr><th>Pregunta</th><th>Correcta</th><th>Borrar</th></tr></thead><tbody id="tbodyQuestions"></tbody></table>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modalUser"><div class="modal-box"><span class="close-modal" onclick="closeModals()">&times;</span><h3>Editar Usuario</h3><br><input type="hidden" id="uUserOrigin"><label>DNI</label><input type="text" id="uDNI" class="form-control"><label>Grupo / Etiqueta (Ej: G-01)</label><input type="text" id="uTag" class="form-control"><label>Nueva Contrase帽a</label><input type="password" id="uPass" class="form-control"><button class="btn-action btn-success" style="width:100%" onclick="saveUserEdit()">Guardar</button></div></div>
    
    <div class="modal-overlay" id="modalCourse"><div class="modal-box"><span class="close-modal" onclick="closeModals()">&times;</span><h3 id="courseModalTitle">Material</h3><br><input type="hidden" id="cMode" value="create"><input type="hidden" id="cTitleOrigin"><input type="text" id="cModule" class="form-control" placeholder="Nombre del M贸dulo (Ej: M贸dulo 1)"><input type="text" id="cTitle" class="form-control" placeholder="T铆tulo del Video"><input type="text" id="cDesc" class="form-control" placeholder="Descripci贸n"><input type="text" id="cVideo" class="form-control" placeholder="Link (YouTube, Vimeo, etc)"><select id="cCat" class="form-control"><option>BANCO</option><option>AUNA</option><option>COBRANZAS</option></select><button class="btn-action btn-primary" style="width:100%" onclick="saveCourse()">Guardar</button></div></div>
    
    <div class="modal-overlay" id="modalQuestion"><div class="modal-box"><span class="close-modal" onclick="closeModals()">&times;</span><h3>Pregunta</h3><br><input type="text" id="qText" class="form-control" placeholder="Pregunta"><input type="text" id="qOp1" class="form-control" placeholder="Opci贸n A"><input type="text" id="qOp2" class="form-control" placeholder="Opci贸n B"><input type="text" id="qOp3" class="form-control" placeholder="Opci贸n C"><select id="qCorrect" class="form-control"><option value="op1">Opci贸n A</option><option value="op2">Opci贸n B</option><option value="op3">Opci贸n C</option></select><button class="btn-action btn-success" style="width:100%" onclick="saveQuestion()">Guardar</button></div></div>

    <script>
        // *** PEGA TU NUEVA URL AQUI ***
        const API_URL = 'https://script.google.com/macros/s/AKfycbxQmtqtI3jDSegBlVP7AexJfeal5UcwrfZ0Cyue10ksAafh2Qy-OuNTitAEUg-63lcWMg/exec';

        function nav(id, el) { document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active')); el.classList.add('active'); document.getElementById('pageTitle').innerText = id.toUpperCase(); }
        function closeModals() { document.querySelectorAll('.modal-overlay').forEach(m => m.style.display='none'); }
        function openModal(id) { document.getElementById(id).style.display='flex'; }
        function logout() { if(confirm("驴Salir?")) { localStorage.removeItem('usuarioActual'); window.location.href = 'index.html'; } }
        function post(a, d, c) { let f = new FormData(); f.append('action', a); for(let k in d) f.append(k, d[k]); fetch(API_URL, {method:'POST', body:f}).then(r=>r.json()).then(res=>{ if(res.result==='success')c(res); else alert(res.message); }); }

        // --- USUARIOS + RANKING + DETALLES ---
        function loadUsers() {
            post('readUsers', {}, data => {
                document.getElementById('dUsers').innerText = data.data.length;
                let tbody = document.getElementById('tbodyUsers'); tbody.innerHTML = '';
                let rankingGroups = {};

                data.data.forEach((u, index) => {
                    if(u.rol !== 'admin') {
                        // Logica Ranking
                        let grp = u.etiqueta || "General";
                        if(!rankingGroups[grp]) rankingGroups[grp] = [];
                        rankingGroups[grp].push(u);

                        // Tabla
                        let safeNotas = JSON.stringify(u.detalles).replace(/"/g, '&quot;');
                        tbody.innerHTML += `
                        <tr>
                            <td><span style="font-weight:bold">${u.usuario}</span></td>
                            <td><span class="badge">${u.etiqueta || "-"}</span></td>
                            <td>${u.promedio}</td>
                            <td>
                                <button class="btn-action" style="background:#e0e7ff; color:var(--accent)" onclick="toggleDetails(${index})"> Ver Notas</button>
                                <i class="fas fa-edit action-icons" onclick="editUser('${u.usuario}', '${u.dni}', '${u.etiqueta}')"></i>
                                <i class="fas fa-trash action-icons" onclick="deleteUser('${u.usuario}')"></i>
                            </td>
                        </tr>
                        <tr id="details-${index}" class="details-row" style="display:none"><td colspan="4">
                            <div class="details-content">
                                <h4>Detalle de Evaluaciones:</h4>
                                ${u.detalles.map(d => `<p><b>${d.curso}</b>: ${d.nota}</p>`).join('') || "Sin evaluaciones aun."}
                            </div>
                        </td></tr>`;
                    }
                });
                renderRanking(rankingGroups);
            });
        }

        function renderRanking(groups) {
            let html = '<div style="display:flex; gap:20px; flex-wrap:wrap;">';
            for(let grp in groups) {
                // Ordenar por promedio descendente
                let sorted = groups[grp].sort((a,b) => parseFloat(b.promedio) - parseFloat(a.promedio));
                let top = sorted[0]; // El mejor
                html += `
                <div class="card" style="flex:1; min-width:200px; border-top:5px solid gold;">
                    <h4 style="color:gold"><i class="fas fa-crown"></i> Grupo ${grp}</h4>
                    <p style="font-size:1.5rem; font-weight:bold">${top.usuario}</p>
                    <p>Promedio: ${top.promedio}</p>
                </div>`;
            }
            html += '</div>';
            document.getElementById('rankingContainer').innerHTML = html;
        }

        function toggleDetails(idx) {
            let row = document.getElementById(`details-${idx}`);
            row.style.display = row.style.display === 'none' ? 'table-row' : 'none';
        }

        function editUser(user, dni, tag) {
            document.getElementById('uUserOrigin').value = user;
            document.getElementById('uDNI').value = (dni==="Sin DNI")?"":dni;
            document.getElementById('uTag').value = (tag==="Sin Grupo")?"":tag;
            document.getElementById('uPass').value = "";
            openModal('modalUser');
        }

        function saveUserEdit() {
            post('editUser', {
                UsuarioOriginal: document.getElementById('uUserOrigin').value,
                NuevoDNI: document.getElementById('uDNI').value,
                NuevaEtiqueta: document.getElementById('uTag').value,
                NuevoPass: document.getElementById('uPass').value
            }, res => { alert("Guardado"); closeModals(); loadUsers(); });
        }
        
        function deleteUser(u) { if(confirm("驴Eliminar?")) post('deleteUser', {Usuario:u}, ()=>loadUsers()); }
        function downloadExcel() { post('getFullReport', {}, res => { /* L贸gica CSV igual que antes */ }); }

        // --- CURSOS CON MODULOS ---
        function loadCourses() {
            post('readCourses', {}, data => {
                document.getElementById('dCourses').innerText = data.data.length;
                let tbody = document.getElementById('tbodyCourses'); tbody.innerHTML = '';
                // Agrupar por modulo visualmente (simple sort)
                data.data.sort((a,b) => a.modulo.localeCompare(b.modulo));
                
                data.data.forEach(c => {
                    tbody.innerHTML += `<tr>
                        <td><b>${c.modulo}</b></td>
                        <td>${c.titulo}</td>
                        <td><span class="badge">${c.categoria}</span></td>
                        <td class="action-icons">
                            <i class="fas fa-edit" onclick="prepareEditCourse('${c.titulo}', '${c.descripcion}', '${c.video}', '${c.categoria}', '${c.modulo}')"></i>
                            <i class="fas fa-trash" onclick="deleteCourse('${c.titulo}')"></i>
                        </td>
                    </tr>`;
                });
            });
        }

        function prepareEditCourse(t, d, v, c, m) {
            document.getElementById('cMode').value = 'edit';
            document.getElementById('cTitleOrigin').value = t;
            document.getElementById('cTitle').value = t;
            document.getElementById('cDesc').value = d;
            document.getElementById('cVideo').value = v;
            document.getElementById('cCat').value = c;
            document.getElementById('cModule').value = m; // Nuevo campo modulo
            document.getElementById('courseModalTitle').innerText = "Editar";
            openModal('modalCourse');
        }

        function saveCourse() {
            let mode = document.getElementById('cMode').value;
            let link = document.getElementById('cVideo').value; // Procesador de link se puede a帽adir aqui
            let data = {
                Titulo: document.getElementById('cTitle').value,
                Descripcion: document.getElementById('cDesc').value,
                Video: link,
                Categoria: document.getElementById('cCat').value,
                Modulo: document.getElementById('cModule').value // Enviamos modulo
            };
            if(mode==='create') post('saveCourse', data, ()=> {alert("Creado"); closeModals(); loadCourses();});
            else { data.TituloOriginal = document.getElementById('cTitleOrigin').value; post('editCourse', data, ()=>{alert("Editado"); closeModals(); loadCourses();}); }
        }
        
        function deleteCourse(t) { if(confirm("驴Borrar?")) post('deleteCourse', {Titulo:t}, ()=>loadCourses()); }
        
        // --- EXAMENES ---
        function loadCoursesSelect() { post('readCourses', {}, data => { 
            let sel = document.getElementById('selectCourseExam'); sel.innerHTML = '<option>Selecciona...</option>';
            data.data.forEach(c => { let opt = document.createElement('option'); opt.value=c.titulo; opt.innerText=c.titulo; sel.appendChild(opt); });
        });}
        function loadQuestionsForCourse() { 
            let c = document.getElementById('selectCourseExam').value;
            if(!c) return;
            post('getExam', {Curso:c}, data => {
                let tb = document.getElementById('tbodyQuestions'); tb.innerHTML = '';
                data.data.forEach(q => { tb.innerHTML += `<tr><td>${q.pregunta}</td><td>${q.correcta}</td><td><i class="fas fa-trash" onclick="deleteQ('${c}','${q.pregunta}')"></i></td></tr>`; });
                document.getElementById('tableQuestions').style.display = 'table';
            });
        }
        function openQuestionModal() { if(document.getElementById('selectCourseExam').value) openModal('modalQuestion'); else alert("Selecciona curso"); }
        function saveQuestion() { /* L贸gica igual que antes */ }
        function deleteQ(c, p) { if(confirm("驴Borrar?")) post('deleteQuestion', {Curso:c, Pregunta:p}, ()=>loadQuestionsForCourse()); }
    </script>
</body>
</html>