<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geincos Admin - Panel Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- ESTILOS (DiseÃ±o Oscuro Profesional) --- */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap');
        :root { --bg-dark: #0f172a; --bg-panel: #1e293b; --text-main: #f1f5f9; --text-muted: #94a3b8; --accent-blue: #3b82f6; --accent-green: #10b981; --accent-orange: #f59e0b; --danger: #ef4444; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background-color: var(--bg-dark); color: var(--text-main); display: flex; min-height: 100vh; overflow-x: hidden; }
        
        /* Sidebar */
        .sidebar { width: 260px; background-color: var(--bg-dark); border-right: 1px solid #334155; display: flex; flex-direction: column; padding: 20px; position: fixed; height: 100%; z-index: 10; }
        .brand { font-size: 1.5rem; font-weight: 700; color: #818cf8; margin-bottom: 40px; text-transform: uppercase; letter-spacing: 1px; text-align: center; }
        .menu-item { display: flex; align-items: center; padding: 15px 20px; color: var(--text-muted); text-decoration: none; border-radius: 12px; margin-bottom: 10px; transition: all 0.3s ease; cursor: pointer; }
        .menu-item:hover { background-color: rgba(255,255,255,0.05); color: white; }
        .menu-item.active { background-color: #1e293b; color: var(--text-main); border-left: 4px solid var(--accent-blue); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        
        /* Contenido */
        .main-content { flex: 1; margin-left: 260px; padding: 30px; background-color: var(--bg-dark); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .btn-logout { background: var(--danger); color: white; padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; transition: 0.3s; }
        .btn-logout:hover { background: #dc2626; }
        
        /* Tarjetas Dashboard */
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .card { background: var(--bg-panel); padding: 25px; border-radius: 16px; border: 1px solid #334155; }
        .card h3 { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 10px; }
        .card .number { font-size: 2.5rem; font-weight: 700; }
        .card.blue { border-left: 5px solid var(--accent-blue); }
        .card.green { border-left: 5px solid var(--accent-green); }
        .card.orange { border-left: 5px solid var(--accent-orange); }

        /* Tablas y Formularios */
        .table-container { background: var(--bg-panel); padding: 25px; border-radius: 16px; border: 1px solid #334155; margin-bottom: 30px; }
        .btn-add { background: var(--accent-blue); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; margin-top: 10px; width: 100%; font-weight: 600; transition: 0.3s; }
        .btn-add:hover { background: #2563eb; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; padding: 15px; color: var(--text-muted); border-bottom: 1px solid #334155; font-size: 0.85rem; }
        td { padding: 15px; border-bottom: 1px solid #334155; color: #e2e8f0; font-size: 0.9rem; }
        .form-control { width: 100%; background: #0f172a; border: 1px solid #334155; padding: 12px; border-radius: 8px; color: white; margin-bottom: 15px; }
        
        /* Badges y Barras */
        .badge { padding: 5px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .badge-green { background: rgba(16, 185, 129, 0.2); color: var(--accent-green); }
        .badge-red { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .badge-yellow { background: rgba(245, 158, 11, 0.2); color: var(--accent-orange); }
        
        .progress-bg { width: 100px; height: 6px; background: #334155; border-radius: 10px; display: inline-block; margin-right: 10px; vertical-align: middle; }
        .progress-fill { height: 100%; background: var(--accent-blue); border-radius: 10px; transition: width 0.5s ease; }

        .content-section { display: none; animation: fadeIn 0.4s ease; }
        .content-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="brand">GEINCOS ADMIN</div>
        <div class="menu-item active" onclick="showSection('dashboard', this)">
            <i class="fas fa-th-large"></i> Dashboard
        </div>
        <div class="menu-item" onclick="showSection('usuarios', this); cargarUsuarios()">
            <i class="fas fa-users"></i> Usuarios y Avance
        </div>
        <div class="menu-item" onclick="showSection('cursos', this); cargarCursos()">
            <i class="fas fa-graduation-cap"></i> GestiÃ³n de Cursos
        </div>
    </div>

    <div class="main-content">
        <div class="header">
            <h2 id="page-title">Dashboard Principal</h2>
            <button class="btn-logout" onclick="if(confirm('Â¿Cerrar SesiÃ³n?')) window.location.href='index.html'">
                <i class="fas fa-sign-out-alt"></i> Salir
            </button>
        </div>

        <div id="dashboard" class="content-section active">
            <div class="cards-grid">
                <div class="card blue">
                    <h3>Total Usuarios</h3>
                    <div class="number" id="dashUsers">--</div>
                </div>
                <div class="card green">
                    <h3>Promedio Global</h3>
                    <div class="number" id="dashPromedio">--</div>
                </div>
                <div class="card orange">
                    <h3>Cursos Creados</h3>
                    <div class="number" id="dashCursos">--</div>
                </div>
            </div>
            <div style="text-align: center;">
                <button class="btn-add" style="width: auto;" onclick="cargarUsuarios(); cargarCursos();">
                    ðŸ”„ Actualizar Todo
                </button>
            </div>
        </div>

        <div id="usuarios" class="content-section">
            <div class="table-container">
                <h3>Progreso AcadÃ©mico</h3>
                <button class="btn-add" style="width:auto; margin-bottom:15px; background:#334155" onclick="cargarUsuarios()">
                    <i class="fas fa-sync"></i> Recargar
                </button>
                
                <table>
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>Avance</th>
                            <th>Promedio</th>
                            <th>Estado</th>
                            <th>Rol</th>
                        </tr>
                    </thead>
                    <tbody id="tablaUsuariosBody">
                        <tr><td colspan="5" style="text-align:center; padding:20px;">Cargando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="cursos" class="content-section">
            <div class="table-container">
                <h3>ðŸ“š Crear Nuevo Curso</h3>
                <br>
                <form id="formCursos">
                    <input type="text" id="txtTitulo" class="form-control" placeholder="TÃ­tulo del Curso (Ej: Ventas Efectivas)">
                    <input type="text" id="txtDesc" class="form-control" placeholder="DescripciÃ³n Breve">
                    
                    <label style="color:#94a3b8; font-size:0.9rem">Enlace de YouTube (Cualquier formato):</label>
                    <input type="text" id="txtVideo" class="form-control" placeholder="Pega aquÃ­ el link (https://youtube.com/...)">
                    
                    <select id="txtCat" class="form-control">
                        <option>BANCO (NATURA Y DUPREE)</option>
                        <option>AUNA</option>
                        <option>COBRANZAS</option>
                        <option>GENERAL</option>
                    </select>
                    <button type="button" class="btn-add" onclick="guardarCurso()">ðŸ’¾ Guardar y Publicar Curso</button>
                </form>
            </div>

            <div class="table-container">
                <h3>Cursos Disponibles</h3>
                <table>
                    <thead>
                        <tr>
                            <th>TÃ­tulo</th>
                            <th>CategorÃ­a</th>
                            <th>Video (Link Limpio)</th>
                            <th>Fecha</th>
                        </tr>
                    </thead>
                    <tbody id="tablaCursosBody">
                        <tr><td colspan="4" style="text-align:center;">Cargando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycbwbZGnpQm44A8VALhDZTyowmlOtnK8is_qAh5QYjWm4T-bN17ICWdeKfXyyLlFrGYt45g/exec';

        function showSection(id, el) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
            if(el) el.classList.add('active');
            document.getElementById('page-title').innerText = id === 'dashboard' ? 'Dashboard' : 'GestiÃ³n ' + id;
        }

        // --- FUNCIÃ“N QUE LIMPIA EL LINK ---
        function limpiarLinkYoutube(url) {
            // ExpresiÃ³n regular que detecta cualquier tipo de link de Youtube
            var regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            var match = url.match(regExp);

            if (match && match[2].length == 11) {
                // Si encontramos el ID de 11 caracteres, creamos el link EMBED perfecto
                return "https://www.youtube.com/embed/" + match[2];
            } else {
                return null; // Link invÃ¡lido
            }
        }

        function guardarCurso() {
            const btn = document.querySelector('#formCursos button');
            const rawLink = document.getElementById('txtVideo').value;
            
            // 1. Validamos y limpiamos el link
            const linkLimpio = limpiarLinkYoutube(rawLink);
            
            if (!linkLimpio) {
                alert("âš ï¸ Error: El enlace de YouTube no es vÃ¡lido.\nAsegÃºrate de copiar bien la direcciÃ³n del video.");
                return; // Detenemos el guardado
            }

            btn.innerText = "Guardando..."; btn.disabled = true;
            
            let formData = new FormData();
            formData.append('action', 'saveCourse');
            formData.append('Titulo', document.getElementById('txtTitulo').value);
            formData.append('Descripcion', document.getElementById('txtDesc').value);
            formData.append('Video', linkLimpio); // Â¡ENVIAMOS EL LINK LIMPIO!
            formData.append('Categoria', document.getElementById('txtCat').value);

            fetch(scriptURL, { method: 'POST', body: formData }).then(r => r.json()).then(d => {
                alert("Â¡Curso Creado! El link se corrigiÃ³ automÃ¡ticamente."); 
                document.getElementById('formCursos').reset();
                btn.innerText = "ðŸ’¾ Guardar y Publicar Curso"; btn.disabled = false;
                cargarCursos();
            }).catch(e => { alert("Error de conexiÃ³n"); btn.disabled = false; });
        }

        // --- RESTO DE FUNCIONES (Lectura) ---
        function cargarUsuarios() {
            const tabla = document.getElementById('tablaUsuariosBody');
            tabla.innerHTML = '<tr><td colspan="5" style="text-align:center">Cargando... <i class="fas fa-spinner fa-spin"></i></td></tr>';
            let formData = new FormData(); formData.append('action', 'readUsers');
            fetch(scriptURL, { method: 'POST', body: formData }).then(r => r.json()).then(data => {
                tabla.innerHTML = '';
                let totalUsuarios = 0, sumaPromedios = 0, contPromedios = 0;
                if(data.data.length === 0) tabla.innerHTML = '<tr><td colspan="5" style="text-align:center">Sin usuarios</td></tr>';

                data.data.forEach(u => {
                    let barraAncho = u.cursos > 10 ? 100 : (u.cursos * 10); 
                    let badgeClass = u.promedio >= 15 ? 'badge-green' : (u.cursos == 0 ? 'badge-yellow' : 'badge-red');
                    let estadoTexto = u.promedio >= 15 ? 'Excelente' : (u.cursos == 0 ? 'Sin Iniciar' : 'En Riesgo');

                    if(u.rol !== 'admin') { totalUsuarios++; if(u.cursos > 0) { sumaPromedios += parseFloat(u.promedio); contPromedios++; } }

                    tabla.innerHTML += `<tr>
                        <td style="font-weight:bold; color:white"><i class="fas fa-user-circle" style="color:#3b82f6"></i> ${u.usuario}</td>
                        <td><div class="progress-bg"><div class="progress-fill" style="width:${barraAncho}%"></div></div> ${u.cursos}</td>
                        <td style="font-weight:bold">${u.promedio}</td>
                        <td><span class="badge ${badgeClass}">${estadoTexto}</span></td>
                        <td style="color:#94a3b8; font-size:0.8rem">${u.rol}</td>
                    </tr>`;
                });
                document.getElementById('dashUsers').innerText = totalUsuarios;
                document.getElementById('dashPromedio').innerText = contPromedios > 0 ? (sumaPromedios / contPromedios).toFixed(1) : 0;
            });
        }

        function cargarCursos() {
            let formData = new FormData(); formData.append('action', 'readCourses');
            fetch(scriptURL, { method: 'POST', body: formData }).then(r => r.json()).then(d => {
                document.getElementById('dashCursos').innerText = d.data.length;
                let tbody = document.getElementById('tablaCursosBody');
                tbody.innerHTML = '';
                if(d.data.length === 0) tbody.innerHTML = '<tr><td colspan="4" style="text-align:center">Sin cursos</td></tr>';
                
                d.data.forEach(c => {
                    tbody.innerHTML += `<tr>
                        <td style="color:white">${c.titulo}</td>
                        <td><span class="badge badge-green">${c.categoria}</span></td>
                        <td style="color:#3b82f6; font-size:0.8rem; max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${c.video}</td>
                        <td style="color:#94a3b8; font-size:0.8rem">${new Date(c.fecha).toLocaleDateString()}</td>
                    </tr>`;
                });
            });
        }
    </script>
</body>
</html>