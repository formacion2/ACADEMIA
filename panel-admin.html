<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Geincos Admin | Panel de Control</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5;      /* Indigo profesional */
            --primary-dark: #3730a3; 
            --secondary: #818cf8;
            --bg-light: #f3f4f6;     /* Fondo general */
            --surface: #ffffff;      /* Fondo tarjetas */
            --text-main: #111827;
            --text-light: #6b7280;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: var(--bg-light); color: var(--text-main); display: flex; min-height: 100vh; overflow-x: hidden; }

        /* SIDEBAR */
        .sidebar { width: 280px; background: var(--surface); border-right: 1px solid #e5e7eb; padding: 30px 20px; position: fixed; height: 100%; z-index: 50; }
        .brand { display: flex; align-items: center; gap: 12px; margin-bottom: 50px; padding-left: 10px; }
        .brand img { width: 40px; }
        .brand span { font-size: 1.4rem; font-weight: 800; color: var(--primary); letter-spacing: -0.5px; }
        
        .menu-item { display: flex; align-items: center; gap: 15px; padding: 14px 20px; color: var(--text-light); border-radius: 12px; cursor: pointer; transition: 0.3s; font-weight: 600; margin-bottom: 8px; }
        .menu-item:hover { background: #eef2ff; color: var(--primary); transform: translateX(5px); }
        .menu-item.active { background: linear-gradient(90deg, var(--primary), var(--secondary)); color: white; box-shadow: var(--shadow-md); }
        .menu-item i { width: 24px; text-align: center; font-size: 1.2rem; }

        /* MAIN CONTENT */
        .main-content { flex: 1; margin-left: 280px; padding: 40px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; }
        .header h2 { font-size: 1.8rem; font-weight: 800; color: var(--text-main); }
        .btn-logout { padding: 10px 25px; background: #fee2e2; color: var(--danger); border: 1px solid #fecaca; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-logout:hover { background: var(--danger); color: white; }

        /* DASHBOARD CARDS */
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; margin-bottom: 40px; }
        .card { background: var(--surface); padding: 30px; border-radius: 16px; box-shadow: var(--shadow-md); border: 1px solid #e5e7eb; transition: 0.3s; display: flex; align-items: center; gap: 20px; }
        .card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); }
        .card-icon { width: 60px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; }
        .card-info h3 { font-size: 0.9rem; color: var(--text-light); text-transform: uppercase; margin-bottom: 5px; font-weight: 600; }
        .card-info .number { font-size: 2.5rem; font-weight: 800; color: var(--text-main); line-height: 1; }

        /* TABLES */
        .table-container { background: var(--surface); border-radius: 16px; box-shadow: var(--shadow-sm); border: 1px solid #e5e7eb; overflow: hidden; padding: 25px; margin-bottom: 30px; }
        .table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .table-header h3 { font-size: 1.25rem; font-weight: 700; }
        
        table { width: 100%; border-collapse: separate; border-spacing: 0 10px; }
        th { text-align: left; padding: 15px; color: var(--text-light); font-weight: 600; font-size: 0.85rem; text-transform: uppercase; border-bottom: 2px solid #f3f4f6; }
        td { padding: 15px; background: #f9fafb; border-top: 1px solid #e5e7eb; border-bottom: 1px solid #e5e7eb; color: var(--text-main); vertical-align: middle; }
        td:first-child { border-left: 1px solid #e5e7eb; border-top-left-radius: 10px; border-bottom-left-radius: 10px; font-weight: 600; }
        td:last-child { border-right: 1px solid #e5e7eb; border-top-right-radius: 10px; border-bottom-right-radius: 10px; text-align: right; }

        /* BUTTONS & BADGES */
        .btn-primary { background: var(--primary); color: white; padding: 12px 24px; border-radius: 10px; border: none; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-2px); }
        .btn-success { background: var(--success); color: white; padding: 12px 24px; border-radius: 10px; border: none; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; }
        
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
        .bg-blue { background: #e0e7ff; color: var(--primary); }
        .bg-green { background: #dcfce7; color: var(--success); }

        .action-btn { width: 35px; height: 35px; border-radius: 8px; border: none; cursor: pointer; transition: 0.2s; font-size: 1rem; margin-left: 5px; }
        .edit-btn { background: #e0e7ff; color: var(--primary); } .edit-btn:hover { background: var(--primary); color: white; }
        .del-btn { background: #fee2e2; color: var(--danger); } .del-btn:hover { background: var(--danger); color: white; }

        /* MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(17, 24, 39, 0.7); z-index: 1000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        .modal-box { background: var(--surface); width: 600px; max-width: 95%; padding: 30px; border-radius: 20px; box-shadow: var(--shadow-lg); max-height: 90vh; overflow-y: auto; position: relative; }
        .close-modal { position: absolute; top: 20px; right: 20px; font-size: 1.5rem; color: var(--text-light); cursor: pointer; }
        
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-light); font-size: 0.9rem; }
        .form-control { width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 10px; outline: none; transition: 0.2s; background: #f9fafb; font-size: 0.95rem; }
        .form-control:focus { border-color: var(--primary); background: white; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        
        /* GAME BUILDER STYLES */
        .game-builder-item { display: flex; gap: 10px; margin-bottom: 10px; background: #f3f4f6; padding: 10px; border-radius: 10px; border: 1px solid #e5e7eb; }
        .content-section { display: none; animation: fadeIn 0.3s ease; } .content-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Custom Scroll */
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: #f1f1f1; } ::-webkit-scrollbar-thumb { background: #c7d2fe; border-radius: 4px; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="brand">
            <img src="geincos.png" alt="Logo">
            <span>Admin</span>
        </div>
        <div class="menu-item active" onclick="nav('dashboard', this)"><i class="fas fa-chart-pie"></i> Dashboard</div>
        <div class="menu-item" onclick="nav('users', this); loadUsers()"><i class="fas fa-users"></i> Usuarios</div>
        <div class="menu-item" onclick="nav('courses', this); loadCourses()"><i class="fas fa-layer-group"></i> Materiales</div>
        <div class="menu-item" onclick="nav('exams', this); loadCoursesSelect()"><i class="fas fa-clipboard-check"></i> Evaluaciones</div>
    </div>

    <div class="main-content">
        <div class="header">
            <h2 id="pageTitle">Dashboard</h2>
            <button class="btn-logout" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Salir</button>
        </div>

        <div id="dashboard" class="content-section active">
            <div class="cards-grid">
                <div class="card">
                    <div class="card-icon" style="background:#e0e7ff; color:var(--primary)"><i class="fas fa-users"></i></div>
                    <div class="card-info"><h3>Total Usuarios</h3><div class="number" id="dUsers">--</div></div>
                </div>
                <div class="card">
                    <div class="card-icon" style="background:#dcfce7; color:var(--success)"><i class="fas fa-chart-line"></i></div>
                    <div class="card-info"><h3>Promedio Global</h3><div class="number" id="dAvg">--</div></div>
                </div>
                <div class="card">
                    <div class="card-icon" style="background:#fef3c7; color:var(--warning)"><i class="fas fa-book"></i></div>
                    <div class="card-info"><h3>Materiales</h3><div class="number" id="dCourses">--</div></div>
                </div>
            </div>
            
            <div class="table-container">
                <div class="table-header">
                    <h3>üèÜ L√≠deres por Grupo</h3>
                    <button class="btn-primary" style="font-size:0.8rem" onclick="loadUsers()">Actualizar</button>
                </div>
                <div id="rankingContainer" style="display:flex; gap:20px; flex-wrap:wrap;">Cargando...</div>
            </div>
        </div>

        <div id="users" class="content-section">
            <div class="table-container">
                <div class="table-header">
                    <h3>Gesti√≥n de Alumnos</h3>
                    <button class="btn-success" onclick="downloadExcel()"><i class="fas fa-file-excel"></i> Descargar Reporte</button>
                </div>
                <table id="tUsers">
                    <thead><tr><th>Usuario</th><th>DNI</th><th>Grupo</th><th>Progreso</th><th>Promedio</th><th>Acciones</th></tr></thead>
                    <tbody id="tbodyUsers"></tbody>
                </table>
            </div>
        </div>

        <div id="courses" class="content-section">
            <div class="table-container">
                <div class="table-header">
                    <h3>Biblioteca de Contenido</h3>
                    <button class="btn-primary" onclick="openModalCourse('create')"><i class="fas fa-plus"></i> Nuevo Material</button>
                </div>
                <table id="tCourses">
                    <thead><tr><th>M√≥dulo</th><th>T√≠tulo</th><th>Tipo</th><th>Categor√≠a</th><th>Acciones</th></tr></thead>
                    <tbody id="tbodyCourses"></tbody>
                </table>
            </div>
        </div>

        <div id="exams" class="content-section">
            <div class="table-container">
                <div class="table-header">
                    <h3>Gesti√≥n de Ex√°menes</h3>
                    <div style="display:flex; gap:10px">
                        <select id="selectCourseExam" class="form-control" style="margin:0; width:200px" onchange="loadQuestionsForCourse()"><option>Selecciona Curso...</option></select>
                        <button class="btn-primary" onclick="openQModal()">+ Pregunta</button>
                    </div>
                </div>
                <table id="tQuestions">
                    <thead><tr><th>Pregunta</th><th>Respuesta Correcta</th><th>Acciones</th></tr></thead>
                    <tbody id="tbodyQuestions"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modalUser">
        <div class="modal-box">
            <i class="fas fa-times close-modal" onclick="closeModals()"></i>
            <h3 style="margin-bottom:20px; font-size:1.5rem; color:var(--primary)">Editar Usuario</h3>
            <input type="hidden" id="uUserOrigin">
            <div class="form-group"><label class="form-label">DNI</label><input type="text" id="uDNI" class="form-control"></div>
            <div class="form-group"><label class="form-label">Grupo (Etiqueta)</label><input type="text" id="uTag" class="form-control" placeholder="Ej: G-01"></div>
            <div class="form-group"><label class="form-label">Nueva Contrase√±a</label><input type="password" id="uPass" class="form-control" placeholder="Dejar vac√≠o si no cambia"></div>
            <button class="btn-primary" style="width:100%" onclick="saveUserEdit()">Guardar Cambios</button>
        </div>
    </div>

    <div class="modal-overlay" id="modalCourse">
        <div class="modal-box">
            <i class="fas fa-times close-modal" onclick="closeModals()"></i>
            <h3 style="margin-bottom:20px; font-size:1.5rem; color:var(--primary)" id="courseModalTitle">Nuevo Material</h3>
            
            <input type="hidden" id="cMode" value="create">
            <input type="hidden" id="cTitleOrigin">

            <div class="form-group"><label class="form-label">M√≥dulo</label><input type="text" id="cModule" class="form-control" placeholder="Ej: M√≥dulo 1"></div>
            <div class="form-group"><label class="form-label">T√≠tulo</label><input type="text" id="cTitle" class="form-control"></div>
            <div class="form-group"><label class="form-label">Categor√≠a</label><select id="cCat" class="form-control"><option>BANCO</option><option>AUNA</option><option>COBRANZAS</option></select></div>
            <div class="form-group"><label class="form-label">Tipo de Contenido</label>
                <select id="cType" class="form-control" onchange="toggleBuilder()">
                    <option value="video">üìπ Video</option>
                    <option value="completar">üß© Completar Espacios</option>
                    <option value="flashcard">üÉè Flashcards (Memoria)</option>
                    <option value="trivia">‚ö° Trivia (V/F)</option>
                    <option value="simulador">üí¨ Simulador</option>
                </select>
            </div>

            <div id="vidSec" class="form-group"><label class="form-label">Enlace del Video</label><input type="text" id="cVideo" class="form-control" placeholder="YouTube, Vimeo, Drive..."></div>
            <input type="hidden" id="cDesc" value="Material educativo">

            <div id="gameSec" style="display:none; background:#f0f9ff; padding:20px; border-radius:15px; border:1px solid #bae6fd; margin-bottom:20px;">
                <h4 style="color:var(--primary); margin-bottom:15px">Configuraci√≥n del Juego</h4>
                
                <div id="areaCompletar" style="display:none">
                    <label class="form-label">Frase (Usa [corchetes] para ocultar palabras)</label>
                    <textarea id="gameTextarea" class="form-control" rows="3" placeholder="La capital de Per√∫ es [Lima]."></textarea>
                </div>

                <div id="listBuilder">
                    <div id="gameItems"></div>
                    <button class="btn-success" style="font-size:0.8rem; padding:8px 15px;" onclick="addGameItem()">+ Agregar √çtem</button>
                </div>
            </div>

            <button class="btn-primary" style="width:100%" onclick="saveMaterial()">Guardar Material</button>
        </div>
    </div>

    <div class="modal-overlay" id="modalQ">
        <div class="modal-box">
            <i class="fas fa-times close-modal" onclick="closeModals()"></i>
            <h3 style="margin-bottom:20px; font-size:1.5rem; color:var(--primary)">Pregunta de Examen</h3>
            
            <input type="hidden" id="qMode" value="create"> 
            <input type="hidden" id="qOriginalText"> 
            
            <div class="form-group"><label class="form-label">Pregunta</label><input type="text" id="qTxt" class="form-control"></div>
            <div class="form-group">
                <label class="form-label">Opciones</label>
                <input type="text" id="op1" class="form-control" placeholder="Opci√≥n A" style="border-left:4px solid #ef4444">
                <input type="text" id="op2" class="form-control" placeholder="Opci√≥n B" style="border-left:4px solid #3b82f6">
                <input type="text" id="op3" class="form-control" placeholder="Opci√≥n C" style="border-left:4px solid #f59e0b">
            </div>
            <div class="form-group"><label class="form-label">Respuesta Correcta</label>
                <select id="correct" class="form-control"><option value="op1">Opci√≥n A</option><option value="op2">Opci√≥n B</option><option value="op3">Opci√≥n C</option></select>
            </div>
            <button class="btn-primary" style="width:100%" onclick="saveQ()">Guardar Pregunta</button>
        </div>
    </div>

    <script>
        const API = 'https://script.google.com/macros/s/AKfycbx4WFS3Gndn-6T6_ikhb3sbLyVNnwpHjBtq82uDYWlbdiom2PCOzTqCp6-mSDcy0YgNPg/exec';

        // NAVEGACI√ìN
        function nav(id, el) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('pageTitle').innerText = id.toUpperCase();
        }
        function closeModals() { document.querySelectorAll('.modal-overlay').forEach(m => m.style.display='none'); }
        function logout() { if(confirm("¬øSalir?")) { localStorage.removeItem('usuarioActual'); window.location.href = 'index.html'; } }
        function post(a,d,c){ let f=new FormData(); f.append('action',a); for(let k in d)f.append(k,d[k]); fetch(API,{method:'POST', body:f}).then(r=>r.json()).then(c); }

        // 1. USUARIOS (Editar Completo)
        function loadUsers(){ 
            post('readUsers',{},d=>{ 
                document.getElementById('dUsers').innerText=d.data.length;
                let h=''; let grps={};
                d.data.forEach(u=>{ 
                    if(u.rol!='admin') {
                        if(!grps[u.etiqueta]) grps[u.etiqueta]=[]; grps[u.etiqueta].push(u);
                        // C√°lculo barra progreso
                        let width = Math.min(u.cursos * 10, 100);
                        h+=`<tr>
                            <td><div style="font-weight:bold">${u.usuario}</div><small style="color:#9ca3af">${u.rol}</small></td>
                            <td>${u.dni}</td>
                            <td><span class="badge bg-blue">${u.etiqueta||'Gen'}</span></td>
                            <td><div class="progress-bg" style="width:100px; height:6px; background:#e5e7eb; border-radius:10px"><div style="width:${width}%; height:100%; background:var(--primary); border-radius:10px"></div></div> <small>${u.cursos} temas</small></td>
                            <td style="font-weight:bold">${u.promedio}</td>
                            <td>
                                <button class="action-btn edit-btn" onclick="editU('${u.usuario}','${u.dni}','${u.etiqueta}')"><i class="fas fa-edit"></i></button>
                                <button class="action-btn del-btn" onclick="delU('${u.usuario}')"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`;
                    }
                });
                document.querySelector('#tbodyUsers').innerHTML=h;
                renderRank(grps);
            });
        }
        
        function renderRank(g){
            let h='';
            for(let k in g){
                let top = g[k].sort((a,b)=>b.promedio-a.promedio)[0];
                h+=`<div class="card" style="padding:15px; min-width:200px; flex:1">
                    <div class="card-icon" style="background:#fef3c7; color:#f59e0b; font-size:1.2rem; width:40px; height:40px"><i class="fas fa-crown"></i></div>
                    <div><h4 style="margin:0; font-size:0.8rem; color:#6b7280">Grupo ${k}</h4><div style="font-weight:bold; font-size:1.1rem">${top.usuario}</div><small>${top.promedio} pts</small></div>
                </div>`;
            }
            document.getElementById('rankingContainer').innerHTML=h;
        }

        function editU(u,d,t){ document.getElementById('uUserOrigin').value=u; document.getElementById('uDNI').value=(d=='Sin DNI'?'':d); document.getElementById('uTag').value=t; document.getElementById('uPass').value=""; document.getElementById('modalUser').style.display='flex'; }
        function saveUserEdit() { post('editUser',{UsuarioOriginal:document.getElementById('uUserOrigin').value, NuevoDNI:document.getElementById('uDNI').value, NuevaEtiqueta:document.getElementById('uTag').value, NuevoPass:document.getElementById('uPass').value},()=>{ alert('Usuario Actualizado'); closeModals(); loadUsers(); }); }
        function delU(u){ if(confirm('¬øEliminar usuario?')) post('deleteUser',{Usuario:u},loadUsers); }
        function downloadExcel(){ post('getFullReport',{},res=>{ let csv="Usuario,DNI,Nota\n"; res.data.forEach(r=>{csv+=`${r.usuario},${r.dni},${r.promedio}\n`}); let a=document.createElement('a'); a.href=encodeURI("data:text/csv;charset=utf-8,"+csv); a.download="Reporte.csv"; a.click(); }); }

        // 2. CURSOS & JUEGOS (Edici√≥n Avanzada)
        function loadCourses(){ 
            post('readCourses',{},d=>{
                document.getElementById('dCourses').innerText=d.data.length;
                let h=''; 
                d.data.sort((a,b)=>a.modulo.localeCompare(b.modulo));
                d.data.forEach(c=>{ 
                    let icon = c.tipo=='video' ? 'üìπ' : 'üéÆ';
                    // Guardamos los datos en el bot√≥n editar para re-llenar el modal
                    let safeData = encodeURIComponent(c.dataJuego || "");
                    h+=`<tr>
                        <td><b>${c.modulo}</b></td>
                        <td>${c.titulo}</td>
                        <td><span class="badge bg-blue">${icon} ${c.tipo.toUpperCase()}</span></td>
                        <td>${c.categoria}</td>
                        <td>
                            <button class="action-btn edit-btn" onclick="editCourse('${c.titulo}','${c.modulo}','${c.categoria}','${c.tipo}','${c.video}','${safeData}')"><i class="fas fa-edit"></i></button>
                            <button class="action-btn del-btn" onclick="delC('${c.titulo}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`; 
                });
                document.querySelector('#tbodyCourses').innerHTML=h;
            });
        }

        function openModalCourse(mode){
            document.getElementById('modalCourse').style.display='flex';
            document.getElementById('cMode').value = mode;
            if(mode==='create'){
                document.getElementById('courseModalTitle').innerText = "Nuevo Material";
                document.getElementById('cTitle').value=""; document.getElementById('cVideo').value=""; 
                document.getElementById('gameItems').innerHTML="";
                toggleBuilder();
            }
        }

        function editCourse(t, m, c, type, vid, dataEncoded){
            document.getElementById('cMode').value = 'edit';
            document.getElementById('cTitleOrigin').value = t; // Para buscar y actualizar
            
            document.getElementById('cTitle').value = t;
            document.getElementById('cModule').value = m;
            document.getElementById('cCat').value = c;
            document.getElementById('cType').value = type;
            document.getElementById('cVideo').value = vid;
            
            document.getElementById('courseModalTitle').innerText = "Editar Material";
            document.getElementById('modalCourse').style.display='flex';

            toggleBuilder(); // Mostrar secci√≥n correcta

            // Si es juego, repoblar los campos
            if(type !== 'video'){
                try {
                    let json = JSON.parse(decodeURIComponent(dataEncoded));
                    if(type === 'completar') {
                        document.getElementById('gameTextarea').value = json.text || "";
                    } else {
                        document.getElementById('gameItems').innerHTML = ""; // Limpiar
                        json.forEach(item => {
                            addGameItem(item.q, item.a);
                        });
                    }
                } catch(e) { console.log("Error parseando juego", e); }
            }
        }

        function toggleBuilder(){ 
            let t=document.getElementById('cType').value; 
            document.getElementById('vidSec').style.display=(t=='video'?'block':'none'); 
            document.getElementById('gameSec').style.display=(t!='video'?'block':'none'); 
            
            if(t==='completar') {
                document.getElementById('listBuilder').style.display='none';
                document.getElementById('areaCompletar').style.display='block';
            } else {
                document.getElementById('listBuilder').style.display='block';
                document.getElementById('areaCompletar').style.display='none';
                // Si est√° vac√≠o al cambiar, agregar uno
                if(document.getElementById('gameItems').innerHTML === '') addGameItem();
            }
        }

        function addGameItem(qVal = "", aVal = ""){ 
            let d=document.createElement('div'); d.className='game-builder-item'; 
            d.innerHTML=`<input class="form-control q" style="margin:0" placeholder="Pregunta" value="${qVal}"><input class="form-control a" style="margin:0" placeholder="Respuesta" value="${aVal}"><i class="fas fa-times" style="color:red; cursor:pointer" onclick="this.parentElement.remove()"></i>`; 
            document.getElementById('gameItems').appendChild(d); 
        }
        
        function saveMaterial(){
            let t=document.getElementById('cType').value, link="", json="";
            
            // L√≥gica Video
            if(t=='video') {
                 let raw = document.getElementById('cVideo').value;
                 // Limpiar solo si es youtube, si no dejar igual
                 let m = raw.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/);
                 link = (m && m[2].length == 11) ? "https://www.youtube.com/embed/" + m[2] : raw;
            } 
            // L√≥gica Juegos
            else {
                if(t === 'completar') {
                    json = JSON.stringify({ text: document.getElementById('gameTextarea').value });
                } else {
                    let items=[]; 
                    document.querySelectorAll('.game-builder-item').forEach(el=>{ 
                        items.push({q:el.querySelector('.q').value, a:el.querySelector('.a').value}); 
                    });
                    json=JSON.stringify(items);
                }
            }

            let d={
                Titulo:document.getElementById('cTitle').value, 
                Modulo:document.getElementById('cModule').value, 
                Categoria:document.getElementById('cCat').value, 
                Tipo:t, 
                Video:link, 
                DataJuego:json, 
                Descripcion:'-' // Campo obligatorio
            };
            
            let mode = document.getElementById('cMode').value;
            if(mode === 'create') {
                post('saveCourse', d, ()=>{ alert("Creado"); closeModals(); loadCourses(); });
            } else {
                d.TituloOriginal = document.getElementById('cTitleOrigin').value;
                post('editCourse', d, ()=>{ alert("Actualizado"); closeModals(); loadCourses(); });
            }
        }

        function delC(t){ if(confirm('¬øBorrar?')) post('deleteCourse',{Titulo:t},loadCourses); }

        // 3. EVALUACIONES (Edici√≥n B√°sica - Borrar y Crear)
        // Nota: Para editar preguntas, lo m√°s f√°cil en Excel sin IDs es borrar y crear de nuevo.
        // Aqu√≠ implementaremos la carga para que se pueda borrar.
        
        function loadCoursesSelect() { post('readCourses', {}, data => { let s=document.getElementById('selectCourseExam'); s.innerHTML='<option>Selecciona...</option>'; data.data.forEach(c=>{let o=document.createElement('option'); o.value=c.titulo; o.innerText=c.titulo; s.appendChild(o);}); }); }
        
        function loadQ(){ 
            let c=document.getElementById('selectCourseExam').value; 
            if(!c) return; 
            post('getExam',{Curso:c},d=>{ 
                let h=''; 
                d.data.forEach(q=>{
                    // Agregamos un bot√≥n para "Editar" que en realidad abre el modal para crear una nueva (se asume que el usuario borra la anterior)
                    // O podr√≠amos implementar "editQuestion" en el backend si fuera necesario.
                    // Por ahora, Delete es suficiente para mantenimiento.
                    h+=`<tr>
                        <td>${q.pregunta}</td>
                        <td><span class="badge bg-green">${q.correcta}</span></td>
                        <td><button class="action-btn del-btn" onclick="delQ('${c}','${q.pregunta}')"><i class="fas fa-trash"></i></button></td>
                    </tr>`; 
                }); 
                document.querySelector('#tQuestions tbody').innerHTML=h; 
                document.getElementById('tableQuestions').style.display='table'; 
            }); 
        }
        
        function openQModal(){ if(document.getElementById('selectCourseExam').value!='Selecciona...') document.getElementById('modalQ').style.display='flex'; else alert('Selecciona curso'); }
        
        function saveQ(){ 
            let op1=document.getElementById('op1').value, op2=document.getElementById('op2').value, op3=document.getElementById('op3').value;
            let sel = document.getElementById('correct').value;
            let correcta = (sel=='op1')?op1:(sel=='op2')?op2:op3;
            
            let data = { 
                Curso: document.getElementById('selectCourseExam').value, 
                Pregunta: document.getElementById('qTxt').value, 
                Op1: op1, Op2: op2, Op3: op3, Correcta: correcta 
            }; 
            post('saveQuestion', data, res => { alert("Pregunta guardada"); closeModals(); loadQ(); }); 
        }
        
        function delQ(c,p){ if(confirm('¬øBorrar pregunta?')) post('deleteQuestion',{Curso:c, Pregunta:p},()=>loadQ()); }

    </script>
</body>
</html>