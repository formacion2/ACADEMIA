<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Geincos Admin | Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ESTILOS COMPARTIDOS */
        :root { --primary: #4338ca; --bg-body: #f1f5f9; --surface: #ffffff; --text-main: #0f172a; --text-muted: #64748b; --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --border: #e2e8f0; --shadow-sm: 0 1px 2px 0 rgba(0,0,0,0.05); }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: var(--bg-body); color: var(--text-main); display: flex; height: 100vh; overflow: hidden; }
        
        /* SIDEBAR */
        .sidebar { width: 260px; background: var(--surface); border-right: 1px solid var(--border); padding: 24px; display: flex; flex-direction: column; z-index: 50; }
        .brand { display: flex; align-items: center; gap: 12px; margin-bottom: 40px; padding-left: 8px; }
        .brand img { width: 36px; } .brand span { font-size: 1.25rem; font-weight: 800; color: var(--primary); }
        .menu-label { font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); font-weight: 700; margin-bottom: 10px; margin-top: 20px; padding-left: 10px; }
        .menu-item { padding: 12px 16px; color: var(--text-muted); border-radius: 8px; cursor: pointer; margin-bottom: 4px; font-weight: 500; display: flex; align-items: center; gap: 12px; transition: 0.2s; text-decoration: none; }
        .menu-item:hover { background: #eef2ff; color: var(--primary); }
        .menu-item.active { background: var(--primary); color: white; }
        .menu-item i { width: 20px; text-align: center; font-size: 1.1rem; }

        /* MAIN CONTENT */
        .main-content { flex: 1; padding: 32px; overflow-y: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; }
        .page-title h2 { font-size: 1.8rem; font-weight: 800; letter-spacing: -0.5px; }
        .btn-primary { background: var(--primary); color: white; padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; }

        /* DASHBOARD WIDGETS */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: var(--surface); padding: 24px; border-radius: 16px; border: 1px solid var(--border); position: relative; overflow: hidden; }
        .kpi-card::before { content:''; position: absolute; top:0; left:0; width: 4px; height: 100%; background: var(--primary); }
        .kpi-label { font-size: 0.8rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; margin-bottom: 5px; }
        .kpi-value { font-size: 2rem; font-weight: 800; color: var(--text-main); margin: 5px 0; }
        .kpi-sub { font-size: 0.85rem; color: var(--text-muted); display: flex; align-items: center; gap: 5px; }

        .dashboard-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-bottom: 30px; }
        .chart-box { background: var(--surface); padding: 24px; border-radius: 16px; border: 1px solid var(--border); height: 400px; display: flex; flex-direction: column; }
        .chart-container-inner { flex: 1; position: relative; width: 100%; overflow: hidden; }
        
        .insights-panel { background: linear-gradient(135deg, #312e81, #4338ca); color: white; padding: 24px; border-radius: 16px; margin-bottom: 30px; }
        .insight-item { display: flex; gap: 12px; margin-bottom: 12px; font-size: 0.95rem; opacity: 0.95; align-items: flex-start; }
        .insight-item i { color: #fbbf24; margin-top: 3px; }

        .table-container { background: var(--surface); border-radius: 16px; border: 1px solid var(--border); overflow: hidden; margin-bottom: 40px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8fafc; text-align: left; padding: 12px 20px; font-size: 0.8rem; font-weight: 700; color: var(--text-muted); border-bottom: 1px solid var(--border); }
        td { padding: 14px 20px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; vertical-align: middle; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
        .bg-green { background: #dcfce7; color: #166534; } .bg-red { background: #fee2e2; color: #991b1b; } .bg-yellow { background: #fef3c7; color: #b45309; } .bg-blue { background: #e0e7ff; color: #3730a3; }
        .progress-track { width: 80px; height: 6px; background: #e2e8f0; border-radius: 10px; display: inline-block; margin-right: 8px; }
        .progress-bar { height: 100%; background: var(--primary); border-radius: 10px; }
        .risk-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
        .risk-low { background: var(--success); box-shadow: 0 0 0 4px #dcfce7; } .risk-med { background: var(--warning); box-shadow: 0 0 0 4px #fef3c7; } .risk-high { background: var(--danger); box-shadow: 0 0 0 4px #fee2e2; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="brand"><img src="geincos.png" alt="Admin"> <span>Admin</span></div>

        <div class="menu-label">ANAL칈TICA</div>
        <a href="dashboard.html" class="menu-item active"><i class="fas fa-chart-pie"></i> Dashboard</a>
        <a href="panel-admin.html#reports" class="menu-item"><i class="fas fa-file-alt"></i> Reportes</a>

        <div class="menu-label">GESTI칍N</div>
        <a href="panel-admin.html#users" class="menu-item"><i class="fas fa-users"></i> Usuarios</a>
        <a href="panel-admin.html#courses" class="menu-item"><i class="fas fa-layer-group"></i> Materiales</a>
        <a href="panel-admin.html#exams" class="menu-item"><i class="fas fa-clipboard-check"></i> Evaluaciones</a>
        
        <div class="menu-item" style="margin-top:auto; color:var(--danger)" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Cerrar Sesi칩n</div>
    </div>

    <div class="main-content">
        <div class="header">
            <div class="page-title">
                <h2>Dashboard Ejecutivo</h2>
                <p>Visi칩n general del desempe침o y cumplimiento.</p>
            </div>
            <button class="btn-primary" onclick="updateDashboard()">游댃 Actualizar</button>
        </div>

        <div class="kpi-grid">
            <div class="kpi-card"><div class="kpi-label">Usuarios Totales</div><div class="kpi-value" id="kpiTotal">--</div><div class="kpi-sub"><i class="fas fa-user-check" style="color:var(--success)"></i> <span id="kpiActive">--%</span> Activos</div></div>
            <div class="kpi-card"><div class="kpi-label">Avance Global</div><div class="kpi-value" id="kpiProgress">--%</div><div class="kpi-sub">Promedio finalizaci칩n</div></div>
            <div class="kpi-card"><div class="kpi-label">Nota Promedio</div><div class="kpi-value" id="kpiAvg">--</div><div class="kpi-sub">Meta: > 14.0</div></div>
            <div class="kpi-card" style="border-left:4px solid var(--danger)"><div class="kpi-label">Riesgo</div><div class="kpi-value"><span id="riskDot" class="risk-indicator risk-low"></span><span id="kpiRisk">--%</span></div><div class="kpi-sub" style="color:var(--danger)"><span id="riskCount">0</span> cr칤ticos</div></div>
        </div>

        <div class="dashboard-grid">
            <div class="chart-box"><h4 style="margin-bottom:15px">Avance por Curso (Top 10)</h4><div class="chart-container-inner"><canvas id="chartProgress"></canvas></div></div>
            <div class="chart-box"><h4 style="margin-bottom:15px">Estado de Cobertura</h4><div class="chart-container-inner"><canvas id="chartActivity"></canvas></div></div>
        </div>

        <div class="insights-panel">
            <h3 style="font-size:1.1rem; margin-bottom:15px; font-weight:700;"><i class="fas fa-robot"></i> Insights Autom치ticos</h3>
            <div id="insightsList">Cargando an치lisis...</div>
        </div>

        <div class="table-container">
            <div style="padding:20px; border-bottom:1px solid #e2e8f0"><h3>Desempe침o por Curso</h3></div>
            <table>
                <thead><tr><th>Curso</th><th>Avance</th><th>Nota Prom.</th><th>Aprobaci칩n</th></tr></thead>
                <tbody id="tbodyPerformance"><tr><td colspan="4" style="text-align:center">Cargando...</td></tr></tbody>
            </table>
        </div>
    </div>

    <script>
        const API = 'https://script.google.com/macros/s/AKfycbxqqV6lXoDWI5IQbC_UL4spYCup5-erGzkgtBq_sV58D7ckBo12U3u7YpMdgcFmBqNlMQ/exec';
        let charts = {};

        window.onload = updateDashboard;

        function post(a,d,c){ let f=new FormData(); f.append('action',a); for(let k in d)f.append(k,d[k]); fetch(API,{method:'POST', body:f}).then(r=>r.json()).then(c); }
        function logout() { if(confirm("쯉alir?")) { localStorage.removeItem('usuarioActual'); window.location.href='index.html'; } }

        function updateDashboard() {
            post('getDashboardMetrics', {}, res => {
                let d = res.data;
                
                // KPIs
                document.getElementById('kpiTotal').innerText = d.alcance.total;
                document.getElementById('kpiActive').innerText = Math.round((d.alcance.activos/d.alcance.total)*100)+"%";
                document.getElementById('kpiRisk').innerText = d.riesgo+"%";
                document.getElementById('riskCount').innerText = d.alcance.inactivos;
                let dot=document.getElementById('riskDot'); dot.className='risk-indicator '+(d.riesgo<10?'risk-low':d.riesgo<30?'risk-med':'risk-high');
                
                let sum=0, cnt=0, fin=0, exp=d.alcance.total*d.cursos.length;
                d.cursos.forEach(c=>{ if(c.promedio>0){sum+=parseFloat(c.promedio); cnt++;} fin+=c.finalizados; });
                document.getElementById('kpiAvg').innerText = cnt>0 ? (sum/cnt).toFixed(1) : "0.0";
                document.getElementById('kpiProgress').innerText = (exp>0?Math.round((fin/exp)*100):0)+"%";

                // Charts
                let top = [...d.cursos].sort((a,b)=>b.tasaFinalizacion-a.tasaFinalizacion).slice(0,10);
                renderChart('chartProgress','bar',top.map(c=>c.nombre),top.map(c=>c.tasaFinalizacion),'#4338ca',true);
                renderChart('chartActivity','doughnut',['Activos','Inactivos'],[d.alcance.activos,d.alcance.inactivos],['#10b981','#ef4444']);

                // Insights
                let ins = document.getElementById('insightsList'); ins.innerHTML='';
                if(d.riesgo>20) ins.innerHTML+=`<div class="insight-item"><i class="fas fa-exclamation-triangle"></i> Alto riesgo (${d.riesgo}% inactivos).</div>`;
                else ins.innerHTML+=`<div class="insight-item"><i class="fas fa-check-circle"></i> Cobertura saludable.</div>`;
                let low = d.cursos.filter(c=>c.tasaAprobacion<60 && c.finalizados>0);
                if(low.length>0) ins.innerHTML+=`<div class="insight-item"><i class="fas fa-arrow-down"></i> Revisar curso: ${low[0].nombre} (${low[0].tasaAprobacion}% aprob.).</div>`;

                // Table
                let tb = document.getElementById('tbodyPerformance'); tb.innerHTML='';
                d.cursos.forEach(c=>{
                    let col = c.tasaAprobacion>=70?'bg-green':c.tasaAprobacion>=50?'bg-yellow':'bg-red';
                    let bgBar = c.tasaFinalizacion>=80?'bg-green':'bg-blue';
                    tb.innerHTML+=`<tr><td><b>${c.nombre}</b></td><td><div class="progress-track"><div class="progress-bar" style="width:${c.tasaFinalizacion}%; background:${bgBar=='bg-green'?'var(--success)':'var(--primary)'}"></div></div> ${c.tasaFinalizacion}%</td><td style="font-weight:bold">${c.promedio}</td><td><span class="badge ${col}">${c.tasaAprobacion}%</span></td></tr>`;
                });
            });
        }

        function renderChart(id,type,lab,dat,col,horiz=false){
            if(charts[id]) charts[id].destroy();
            let ctx=document.getElementById(id).getContext('2d');
            charts[id]=new Chart(ctx,{type:type,data:{labels:lab,datasets:[{data:dat,backgroundColor:col,borderRadius:5}]},options:{responsive:true,maintainAspectRatio:false,indexAxis:horiz?'y':'x',plugins:{legend:{display:type=='doughnut'}}}});
        }
    </script>
</body>
</html>