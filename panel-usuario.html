<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geincos Academy | Mi Espacio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #4338ca; --primary-light: #6366f1; --accent: #f59e0b; --surface: #ffffff; --bg-body: #f3f4f6; --text-main: #111827; --text-light: #6b7280; --success: #10b981; --danger: #ef4444; --shadow-card: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { display: flex; height: 100vh; background-color: var(--bg-body); color: var(--text-main); overflow: hidden; }
        .sidebar { width: 280px; background: var(--surface); display: flex; flex-direction: column; padding: 30px 20px; border-right: 1px solid #e5e7eb; z-index: 50; transition: all 0.3s ease; }
        .brand { display: flex; align-items: center; gap: 15px; margin-bottom: 50px; padding: 0 10px; }
        .brand img { width: 45px; height: auto; } .brand span { font-size: 1.5rem; font-weight: 800; color: var(--primary); letter-spacing: -1px; }
        .menu-item { display: flex; align-items: center; gap: 15px; padding: 16px 20px; color: var(--text-light); border-radius: 16px; cursor: pointer; transition: all 0.3s ease; font-weight: 600; font-size: 1rem; margin-bottom: 8px; }
        .menu-item:hover { background-color: #eef2ff; color: var(--primary); transform: translateX(5px); }
        .menu-item.active { background: linear-gradient(90deg, var(--primary), var(--primary-light)); color: white; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4); }
        .menu-item i { width: 24px; text-align: center; font-size: 1.2rem; }
        .logout-btn { margin-top: auto; color: var(--danger); background: #fef2f2; border: 1px solid #fee2e2; }
        .logout-btn:hover { background: var(--danger); color: white; border-color: var(--danger); }
        .main-content { flex: 1; overflow-y: auto; position: relative; scroll-behavior: smooth; }
        .hero-section { background: linear-gradient(120deg, var(--primary) 0%, #2563eb 100%); padding: 60px 50px 100px 50px; color: white; position: relative; overflow: hidden; border-bottom-left-radius: 40px; border-bottom-right-radius: 40px; box-shadow: 0 10px 30px rgba(37, 99, 235, 0.2); }
        .hero-content h1 { font-size: 2.5rem; font-weight: 800; margin-bottom: 10px; letter-spacing: -1px; }
        .user-pill { background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 20px; font-size: 0.9rem; font-weight: 600; backdrop-filter: blur(5px); margin-left: 10px; border: 1px solid rgba(255,255,255,0.3); }
        .content-wrapper { padding: 0 50px 50px 50px; margin-top: -60px; position: relative; z-index: 10; }
        .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 25px; margin-bottom: 40px; }
        .stat-card { background: var(--surface); padding: 25px; border-radius: 24px; box-shadow: var(--shadow-card); border: 1px solid rgba(255,255,255,0.8); display: flex; align-items: center; gap: 20px; transition: transform 0.3s ease; }
        .stat-icon { width: 60px; height: 60px; border-radius: 18px; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; }
        .icon-blue { background: #e0e7ff; color: var(--primary); } .icon-green { background: #dcfce7; color: var(--success); } .icon-gold { background: #fef3c7; color: var(--accent); }
        .content-section { display: none; animation: fadeInUp 0.5s ease-out; } .content-section.active { display: block; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        /* SIMULADOR */
        .phone-container { width: 100%; max-width: 500px; background: white; border-radius: 24px; box-shadow: 0 15px 35px rgba(0,0,0,0.15); overflow: hidden; display: flex; flex-direction: column; height: 75vh; margin: 0 auto; position: relative; border: 1px solid #e5e7eb; }
        .progress-bar { height: 6px; background: #e5e7eb; width: 100%; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s; }
        .client-zone { background: linear-gradient(180deg, #fce7f3 0%, #ffffff 100%); padding: 20px; display: flex; flex-direction: column; align-items: center; text-align: center; border-bottom: 1px solid #f3f4f6; }
        .avatar { width: 60px; height: 60px; background: #fb7185; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 30px; color: white; margin-bottom: 10px; }
        .client-msg { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); color: var(--text-main); font-weight: 500; font-size: 1rem; border: 1px solid #e5e7eb; }
        .advisor-zone { flex-grow: 1; padding: 20px; overflow-y: auto; background: #fff; }
        /* VISUAL FEEDBACK */
        .option-btn { width: 100%; padding: 15px; margin-bottom: 10px; background: #eff6ff; border: 2px solid #bfdbfe; border-radius: 10px; text-align: left; cursor: pointer; color: #1e3a8a; font-size: 0.95rem; transition: all 0.2s; }
        .option-btn:hover { background: #dbeafe; transform: translateY(-2px); }
        .option-btn.correct { background: #dcfce7 !important; border-color: var(--success) !important; color: #14532d; }
        .option-btn.wrong { background: #fee2e2 !important; border-color: var(--danger) !important; color: #7f1d1d; animation: shake 0.4s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25%, 75% { transform: translateX(-5px); } 50% { transform: translateX(5px); } }
        /* DUELOS */
        .duel-card { background: white; padding: 20px; border-radius: 15px; box-shadow: var(--shadow-card); margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid var(--accent); }
        .duel-info h4 { margin: 0 0 5px 0; color: var(--text-main); }
        .duel-info p { margin: 0; color: var(--text-light); font-size: 0.9rem; }
        .btn-duel { background: var(--accent); color: white; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-weight: bold; }
        /* Course Card, Modals... */
        .module-container { margin-bottom: 25px; background: var(--surface); border-radius: 20px; overflow: hidden; box-shadow: var(--shadow-card); }
        .module-header { padding: 20px 30px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: white; }
        .module-title { font-size: 1.2rem; font-weight: 800; color: var(--text-main); border-left: 5px solid var(--primary); padding-left: 10px; }
        .module-content { padding: 30px; background: #f8fafc; display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 25px; display: none; }
        .module-container.open .module-content { display: grid; }
        .course-card { background: var(--surface); border-radius: 20px; overflow: hidden; box-shadow: var(--shadow-card); transition: all 0.3s; position: relative; border: 1px solid #f1f5f9; display: flex; flex-direction: column; }
        .course-card:hover { transform: translateY(-10px); }
        .thumb-wrapper { height: 190px; overflow: hidden; position: relative; }
        .thumb-img { width: 100%; height: 100%; object-fit: cover; }
        .card-info { padding: 25px; flex: 1; display: flex; flex-direction: column; }
        .card-title { font-size: 1.15rem; font-weight: 700; color: var(--text-main); margin-bottom: 20px; }
        .btn-start { width: 100%; padding: 14px; border-radius: 14px; border: none; font-weight: 700; cursor: pointer; background: var(--primary); color: white; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(17, 24, 39, 0.95); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .modal-window { width: 100%; max-width: 1100px; height: 90vh; background: white; border-radius: 24px; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .modal-top { padding: 20px; background: var(--surface); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e5e7eb; }
        .modal-content-area { flex: 1; background: #000; position: relative; display: flex; align-items: center; justify-content: center; overflow-y: auto; }
        .modal-content-area.game-mode { background: #f8fafc; display: block; padding-top: 40px; }
        
        .video-container-full { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #000; }
        .video-responsive { width: 90%; max-width: 1200px; aspect-ratio: 16 / 9; box-shadow: 0 0 50px rgba(0,0,0,0.5); background: #000; }
        .video-responsive iframe { width: 100%; height: 100%; border: none; }
        .doc-frame { width: 100%; height: 100%; border: none; background: #fff; }
        .image-responsive { max-width: 90%; max-height: 90vh; border-radius: 12px; box-shadow: 0 0 20px rgba(0,0,0,0.5); object-fit: contain; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="brand"><img src="geincos.png" alt="Logo"> <span>Academy</span></div>
        <div class="menu-list">
            <div class="menu-item active" onclick="nav('home', this)">
                <i class="fas fa-layer-group"></i> Mi Aprendizaje
            </div>
            <div class="menu-item" onclick="nav('simulador', this); loadSimuladoresList()"><i class="fas fa-gamepad"></i> Entrenamiento</div>
            <div class="menu-item" onclick="nav('duels', this); loadDuels()">
                <i class="fas fa-bolt"></i> Duelos PvP
            </div>
            <div class="menu-item" onclick="nav('ranking', this)">
                <i class="fas fa-trophy"></i> Tabla de L√≠deres
            </div>
        </div>
        <div class="menu-item logout-btn" onclick="logout()"><i class="fas fa-power-off"></i> Cerrar Sesi√≥n</div>
    </div>

    <div class="main-content">
        <div class="hero-section">
            <div class="hero-content">
                <h1>¬°Hola de nuevo, <span id="nombreUsuario">...</span>! <span class="user-pill" id="userGroup">...</span></h1>
                <p>Contin√∫a desarrollando tus habilidades. Tu progreso es impresionante.</p>
            </div>
        </div>

        <div class="content-wrapper">
            <div id="home" class="content-section active">
                <div class="stats-container">
                    <div class="stat-card"><div class="stat-icon icon-blue"><i class="fas fa-book"></i></div><div class="stat-text"><h4>Cursos</h4><div class="val" id="countCursos">--</div></div></div>
                    <div class="stat-card"><div class="stat-icon icon-green"><i class="fas fa-chart-pie"></i></div><div class="stat-text"><h4>Promedio</h4><div class="val" id="myAverage">--</div></div></div>
                    <div class="stat-card"><div class="stat-icon icon-gold"><i class="fas fa-crown"></i></div><div class="stat-text"><h4>Ranking</h4><div class="val" id="myRank">--</div></div></div>
                </div>
                <div id="coursesContainer"></div>
            </div>

            <div id="ranking" class="content-section">
                <h2 style="margin-bottom:25px; color:var(--text-dark)">üèÜ Top Estudiantes</h2>
                <div class="ranking-box" id="rankingContainer"><p style="padding:30px; text-align:center;">Cargando...</p></div>
            </div>

            <div id="simulador" class="content-section">
                <h2 style="margin-bottom:25px; color:var(--text-dark)">üéÆ Simuladores Disponibles</h2>
                <div id="simListContainer" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px;">
                    <p style="padding:30px;">Cargando simuladores...</p>
                </div>
            </div>

            <div id="duels" class="content-section">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2>‚ö° Duelos de Conocimiento</h2>
                    <button class="btn-start" style="width:auto; background:var(--accent)" onclick="createNewDuel()">‚öîÔ∏è Buscar Reto</button>
                </div>
                <div id="duelsList"><p style="color:#666">Cargando desaf√≠os...</p></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="mainModal"><div class="modal-window"><div class="modal-top"><div class="modal-title" id="modalTitle">Reproductor</div><i class="fas fa-times close-icon" onclick="closeModal()" style="font-size:1.5rem; cursor:pointer"></i></div><div class="modal-content-area" id="playerArea"></div><div class="modal-bottom" id="videoFooter" style="display:none; padding:15px; border-top:1px solid #eee; justify-content:flex-end;"><button id="btnExam" class="btn-exam" onclick="startExam()">Espera...</button></div></div></div>

    <div class="modal-overlay" id="modalPhone"><div class="modal-window" style="background:transparent; box-shadow:none; align-items:center; justify-content:center;"><div style="position:relative"><span onclick="closeModal()" style="position:absolute; top:0; right:-40px; color:white; font-size:2rem; cursor:pointer">&times;</span><div class="phone-container"><div style="padding:15px; background:#f1f5f9; text-align:center; font-weight:bold; border-bottom:1px solid #ddd;">Entrenamiento en Vivo</div><div class="progress-bar"><div id="barra" class="progress-fill"></div></div><div class="client-zone"><div class="avatar">üë§</div><div id="msg-cliente" class="client-msg">Cargando escenario...</div></div><div class="advisor-zone"><p style="text-align:center; color:#666; font-size:0.9rem;" id="titulo-paso">...</p><div id="contenedor-opciones"></div></div></div></div></div></div>

    <script>
        // --- TU NUEVA URL ---
        const API_URL = 'https://script.google.com/macros/s/AKfycbzDUpNjbPMItepTxZMP6a9398qpwD2vCg96UZFEoRJ_Uom6RIwydkd6BtwdzNhwusT5sA/exec';
        
        const currentUser = localStorage.getItem('usuarioActual');
        
        function logout() { if(confirm("¬øCerrar sesi√≥n?")) { localStorage.removeItem('usuarioActual'); window.location.href='index.html'; } }

        if(!currentUser) window.location.href = 'index.html';
        document.getElementById('nombreUsuario').innerText = currentUser;

        let currentGameData = [], currentStep = 0, currentCourseTitle = "", examQuestions = [], timerInterval;
        let datosJuego = [], pasoActual = 0;
        let activeDuelId = null; 
        let duelInterval = null; 

        window.onload = () => { loadContent(); loadRankingData(); };

        function nav(id, el) { document.querySelectorAll('.content-section').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); document.querySelectorAll('.menu-item').forEach(m=>m.classList.remove('active')); el.classList.add('active'); }

        async function loadContent() {
            let f = new FormData(); f.append('action', 'readCourses'); f.append('Usuario', currentUser); 
            let r = await fetch(API_URL, {method:'POST', body:f}); let d = await r.json();
            const container = document.getElementById('coursesContainer'); container.innerHTML = '';
            let modules = {};
            d.data.forEach(c => {
                if(c.tipo === "simulador") return;
                let m = c.modulo || "General"; if(!modules[m]) modules[m] = []; modules[m].push(c);
            });
            document.getElementById('countCursos').innerText = d.data.filter(c=>c.tipo!=='simulador').length;
            
            for(let m in modules) {
                let cardsHtml = '';
                modules[m].forEach(c => {
                    let thumb = 'https://images.unsplash.com/photo-1522202176988-66273c2fd55f?w=800';
                    if(c.tipo === 'video' && c.video) { let vidId = getYouTubeID(c.video); if(vidId) thumb = `https://img.youtube.com/vi/${vidId}/hqdefault.jpg`; }
                    else if(c.tipo === 'imagen') thumb = c.video.includes('drive.google') ? 'https://upload.wikimedia.org/wikipedia/commons/d/da/Google_Drive_logo.png' : c.video; 
                    
                    cardsHtml += `<div class="course-card"><div class="thumb-wrapper"><img src="${thumb}" class="thumb-img" onerror="this.src='https://images.unsplash.com/photo-1522202176988-66273c2fd55f?w=800'"></div><div class="card-info"><span class="cat-tag">${c.categoria}</span><h3 class="card-title">${c.titulo}</h3><button class="btn-start" onclick="launch('${c.tipo}', '${c.video}', '${encodeURIComponent(c.dataJuego||'')}', '${c.titulo}')">Iniciar</button></div></div>`;
                });
                container.innerHTML += `<div class="module-container open"><div class="module-header" onclick="this.parentElement.classList.toggle('open')"><div class="module-title">${m}</div><i class="fas fa-chevron-down"></i></div><div class="module-content">${cardsHtml}</div></div>`;
            }
        }

        async function loadRankingData() {
            let f = new FormData(); f.append('action', 'readUsers'); let r = await fetch(API_URL, {method:'POST', body:f}); let d = await r.json();
            let me = d.data.find(u => u.usuario === currentUser);
            if(me) { document.getElementById('userGroup').innerText = me.etiqueta || "General"; document.getElementById('myAverage').innerText = me.promedio; }
            let list = document.getElementById('rankingContainer'); list.innerHTML = '';
            d.data.filter(u => u.rol!='admin').sort((a,b)=>b.promedio - a.promedio).forEach((u, i) => {
                let isMe = u.usuario===currentUser ? 'background:#eff6ff; border-left:5px solid var(--primary);' : '';
                list.innerHTML += `<div class="rank-item" style="${isMe}"><div class="rank-pos">#${i+1}</div><div class="rank-info">${u.usuario}</div><div class="rank-score">${u.promedio} pts</div></div>`;
            });
        }

        // --- DUELOS ---
        function loadDuels() {
            let f = new FormData(); f.append('action', 'getMyDuels'); f.append('Usuario', currentUser);
            fetch(API_URL, {method:'POST', body:f}).then(r=>r.json()).then(d => {
                if(d.result === 'error') {
                    document.getElementById('duelsList').innerHTML = `<p style="color:red">Error: ${d.message}</p>`;
                    return;
                }
                let html = '';
                if(d.data.length === 0) html = '<p>No tienes duelos activos. ¬°Crea uno!</p>';
                else {
                    d.data.forEach(duel => {
                        let rival = duel.soyRetador ? duel.oponente : duel.retador;
                        let miNota = duel.soyRetador ? duel.notaRetador : duel.notaOponente;
                        let suNota = duel.soyRetador ? duel.notaOponente : duel.notaRetador;
                        let estadoTexto = ''; let btnAction = '';
                        if(miNota === "") { 
                            estadoTexto = '<span style="color:var(--accent)">‚è≥ Tu turno</span>'; 
                            btnAction = `<button class="btn-duel" onclick="playDuel('${duel.id}')">JUGAR</button>`; 
                        } 
                        else if(suNota === "") { 
                            estadoTexto = '<span style="color:var(--primary)">Esperando oponente...</span>'; 
                            btnAction = `<span style="font-weight:bold; color:var(--text-light)">Puntaje: ${miNota}/5</span>`; 
                        } 
                        else { 
                            let res = duel.ganador === currentUser ? 'üèÜ GANASTE' : (duel.ganador === 'EMPATE' ? 'ü§ù EMPATE' : '‚ùå PERDISTE'); 
                            estadoTexto = `<span style="font-weight:bold">${res}</span>`; 
                            btnAction = `<span style="font-weight:bold">${miNota} vs ${suNota}</span>`; 
                        }
                        html += `<div class="duel-card"><div class="duel-info"><h4>Vs. ${rival}</h4><p>${estadoTexto}</p></div><div>${btnAction}</div></div>`;
                    });
                }
                document.getElementById('duelsList').innerHTML = html;
            });
        }

        function createNewDuel() {
            if(!confirm("¬øBuscar un oponente de tu grupo y retarlo ahora?")) return;
            let f = new FormData(); f.append('action', 'createDuel'); f.append('Usuario', currentUser);
            fetch(API_URL, {method:'POST', body:f}).then(r=>r.json()).then(d => {
                if(d.result === 'error') alert(d.message);
                else { alert(`¬°Encontramos a ${d.opponent}! El duelo ha comenzado.`); playDuel(d.duelId); }
            });
        }

        function playDuel(id) {
            activeDuelId = id; 
            const area = document.getElementById('playerArea'); 
            document.getElementById('videoFooter').style.display='none'; 
            document.getElementById('modalTitle').innerText = "‚öîÔ∏è DUELO R√ÅPIDO"; 
            document.getElementById('mainModal').style.display = 'flex';
            area.className = 'modal-content-area game-mode';
            area.innerHTML = '<h2 style="text-align:center; padding:20px; color:var(--primary)">Sincronizando Duelo...</h2><p style="text-align:center">Cargando preguntas...</p>';
            checkDuelState(); if(duelInterval) clearInterval(duelInterval); duelInterval = setInterval(checkDuelState, 2000);
        }

        function checkDuelState() {
            if(!activeDuelId) return;
            let f = new FormData(); f.append('action', 'checkDuelStatus'); f.append('DuelId', activeDuelId);
            fetch(API_URL, {method:'POST', body:f}).then(r=>r.json()).then(res => {
                const area = document.getElementById('playerArea');
                if(res.result === 'success') {
                    let d = res.data; let preguntas = JSON.parse(d.preguntas); let jugadas = JSON.parse(d.jugadas);
                    let indexActual = -1; for(let i=0; i<jugadas.length; i++) { if(jugadas[i] === null) { indexActual = i; break; } }
                    
                    if(d.estado === 'FINALIZADO' || indexActual === -1) {
                        clearInterval(duelInterval);
                        let msg = d.ganador === currentUser ? 'üèÜ ¬°GANASTE!' : (d.ganador==='EMPATE'?'¬°EMPATE!':'‚ùå PERDISTE');
                        area.innerHTML = `<div style="text-align:center; padding:40px;"><h1>${msg}</h1><h3>${d.scoreRetador} vs ${d.scoreOponente}</h3><button class="btn-start" onclick="closeModal()">Salir</button></div>`;
                    } else {
                        let q = preguntas[indexActual];
                        let rivalName = (currentUser == d.retador) ? d.oponente : d.retador;
                        let h = `<div style="width:100%; max-width:600px; padding:20px; margin:0 auto;"><div style="display:flex; justify-content:space-between; margin-bottom:10px; font-weight:bold; color:var(--primary)"><span>T√ö: ${currentUser==d.retador ? d.scoreRetador : d.scoreOponente} pts</span><span>RIVAL (${rivalName}): ${currentUser==d.retador ? d.scoreOponente : d.scoreRetador} pts</span></div><div style="background:white; padding:20px; border-radius:15px; box-shadow:0 4px 10px rgba(0,0,0,0.05)"><h3 style="margin-bottom:20px; color:var(--text-dark)">Pregunta ${indexActual+1}/5</h3><p style="font-size:1.1rem; margin-bottom:20px;">${q.p}</p><button class="option-btn" onclick="sendDuelAnswer(this, ${indexActual}, 'op1', '${q.ok}')">${q.ops[0]}</button><button class="option-btn" onclick="sendDuelAnswer(this, ${indexActual}, 'op2', '${q.ok}')">${q.ops[1]}</button><button class="option-btn" onclick="sendDuelAnswer(this, ${indexActual}, 'op3', '${q.ok}')">${q.ops[2]}</button></div></div>`;
                        area.innerHTML = h;
                    }
                } else {
                    area.innerHTML = `<p style="text-align:center; color:red">Error: ${res.message}</p>`; clearInterval(duelInterval);
                }
            }).catch(e => console.error(e));
        }

        function sendDuelAnswer(btnElement, idx, selected, correct) {
            let allBtns = btnElement.parentElement.querySelectorAll('button');
            allBtns.forEach(b => b.style.pointerEvents = 'none');
            if (selected === correct) btnElement.classList.add('correct'); else btnElement.classList.add('wrong');
            
            let esCorrecta = (selected === correct);
            let f = new FormData(); f.append('action', 'answerDuelQuestion'); f.append('DuelId', activeDuelId); f.append('Usuario', currentUser); f.append('Index', idx); f.append('Correcta', esCorrecta);
            fetch(API_URL, {method:'POST', body:f}).then(r=>r.json()).then(res => {
                if (res.result === 'late') alert("¬°Lento! Tu rival gan√≥ esta pregunta."); 
            });
        }

        // SIMULADORES MULTIPLES
        function loadSimuladoresList() {
            let f = new FormData(); f.append('action', 'readCourses'); f.append('Usuario', currentUser);
            fetch(API_URL, {method:'POST', body:f}).then(r=>r.json()).then(d => {
                let html = '';
                // Filtramos solo los de tipo simulador
                let sims = d.data.filter(c => c.tipo === 'simulador');
                
                if(sims.length === 0) html = '<p>No hay simuladores disponibles.</p>';
                else {
                    sims.forEach(s => {
                         html += `<div class="course-card" onclick="openSimPhone('${encodeURIComponent(s.dataJuego)}')">
                             <div style="height:120px; background:linear-gradient(45deg, #4f46e5, #9333ea); display:flex; align-items:center; justify-content:center; color:white; font-size:3rem;"><i class="fas fa-gamepad"></i></div>
                             <div class="card-info"><h3 class="card-title">${s.titulo}</h3><p style="font-size:0.9rem; color:#666">${s.descripcion}</p></div>
                         </div>`;
                    });
                }
                document.getElementById('simListContainer').innerHTML = html;
            });
        }
        
        function openSimPhone(encodedData) {
            try {
                datosJuego = JSON.parse(decodeURIComponent(encodedData));
                pasoActual = 0;
                document.getElementById('modalPhone').style.display='flex';
                renderizarJuego();
            } catch(e) { alert("Error al cargar simulador"); }
        }

        function renderizarJuego() {
            const paso = datosJuego[pasoActual];
            const barra = document.getElementById('barra'); const msgCliente = document.getElementById('msg-cliente'); const titulo = document.getElementById('titulo-paso'); const contenedor = document.getElementById('contenedor-opciones');
            let total = datosJuego.length; let pct = total > 0 ? (pasoActual / total) * 100 : 0; barra.style.width = pct + "%"; contenedor.innerHTML = '';
            if (!paso) { msgCliente.innerText = "¬°Entrenamiento Completado!"; titulo.innerText = "FIN"; contenedor.innerHTML = '<button class="option-btn" onclick="closeModal()">Terminar</button>'; return; }
            titulo.innerText = `PASO ${pasoActual + 1}: ${paso.titulo}`; msgCliente.innerText = paso.cliente;
            paso.opciones.forEach((textoOp, idx) => { const btn = document.createElement('div'); btn.className = 'option-btn'; btn.innerText = textoOp; btn.onclick = () => validarSim(idx, btn, paso); contenedor.appendChild(btn); });
        }
        function validarSim(idx, btn, paso) {
            document.querySelectorAll('.option-btn').forEach(b => b.style.pointerEvents = 'none');
            if (idx == paso.correcta) { btn.classList.add('correct'); setTimeout(() => { pasoActual++; renderizarJuego(); }, 1000); } 
            else { btn.classList.add('wrong'); alert("‚ö† " + (paso.error || "Respuesta incorrecta")); setTimeout(() => { btn.classList.remove('wrong'); document.querySelectorAll('.option-btn').forEach(b => b.style.pointerEvents = 'auto'); }, 500); }
        }

        // --- LAUNCHER UNIVERSAL (IMAGENES, VIDEO, PDF) ---
        function launch(type, url, data, title) {
            currentCourseTitle = title; document.getElementById('modalTitle').innerText = title;
            const area = document.getElementById('playerArea'); document.getElementById('videoFooter').style.display = 'none';
            document.getElementById('mainModal').style.display = 'flex';
            area.className = type === 'video' ? 'modal-content-area' : 'modal-content-area game-mode'; area.innerHTML = ''; 
            
            if(type === 'video') { 
                document.getElementById('videoFooter').style.display = 'flex'; 
                let vidId = getYouTubeID(url); 
                if(vidId) area.innerHTML = `<div class="video-container-full"><div class="video-responsive"><iframe src="https://www.youtube.com/embed/${vidId}?autoplay=1&rel=0" allowfullscreen></iframe></div></div>`; 
                else area.innerHTML = `<div class="video-container-full"><div class="video-responsive"><iframe src="${url}" allowfullscreen></iframe></div></div>`; 
                startTimer(); loadExam(title); 
            } 
            else if (type === 'imagen') {
                let imgUrl = url;
                if(url.includes('drive.google.com')) {
                    const idMatch = url.match(/\/d\/(.+)\//);
                    if(idMatch) imgUrl = `https://drive.google.com/uc?export=view&id=${idMatch[1]}`;
                }
                // IFRAME PARA DRIVE IMAGES PARA EVITAR BLOQUEOS
                if(url.includes('drive.google.com')) {
                    let driveUrl = url.replace('/view', '/preview');
                    area.innerHTML = `<iframe src="${driveUrl}" class="doc-frame"></iframe>`;
                } else {
                    area.innerHTML = `<div style="text-align:center; height:100%; display:flex; align-items:center; justify-content:center; background:#000;"><img src="${imgUrl}" class="image-responsive" alt="Material"></div>`;
                }
            }
            else if (type === 'pdf' || type === 'ppt') {
                let docUrl = url.includes('drive.google.com') ? url.replace('/view', '/preview') : url;
                area.innerHTML = `<iframe src="${docUrl}" class="doc-frame"></iframe>`;
            }
            else if (type === 'audio') {
                let audioUrl = url.includes('drive.google.com') ? url.replace('/view', '/preview') : url;
                if(url.includes('drive')) area.innerHTML = `<iframe src="${audioUrl}" style="width:100%; height:200px; border:none;"></iframe>`;
                else area.innerHTML = `<div style="text-align:center; height:100%; display:flex; align-items:center; justify-content:center;"><audio controls style="width:80%;"><source src="${url}" type="audio/mpeg">Tu navegador no soporta audio.</audio></div>`;
            }
            else if (type === 'completar') { try { renderFillGame(JSON.parse(decodeURIComponent(data)).text, area); } catch(e){} } 
            else if (type === 'flashcard') { try { currentGameData = JSON.parse(decodeURIComponent(data)); currentStep=0; renderFlashcard(area); } catch(e){} }
        }

        function renderFillGame(text, container) { let parts = text.split(/(\[.*?\])/); let words = [], html = ""; parts.forEach(p => { if(p.startsWith('[') && p.endsWith(']')) { let w = p.slice(1,-1); words.push(w); html += `<span class="drop-zone" ondrop="drop(event)" ondragover="allowDrop(event)" data-ans="${w}"></span>`; } else html += p; }); words.sort(()=>Math.random()-0.5); container.innerHTML = `<div class="fill-container"><div class="word-bank">${words.map(w=>`<div class="draggable-word" draggable="true" ondragstart="drag(event)" id="d-${w}">${w}</div>`).join('')}</div><div class="sentence-area">${html}</div><button class="btn-start" style="width:200px; margin:30px auto" onclick="checkFill()">Verificar</button></div>`; }
        window.allowDrop=e=>e.preventDefault(); window.drag=e=>e.dataTransfer.setData("t",e.target.id); window.drop=e=>{e.preventDefault();let id=e.dataTransfer.getData("t");let el=document.getElementById(id);if(e.target.innerText===""){e.target.innerText=el.innerText;e.target.style.background="#e0e7ff";el.style.display='none';}}; window.checkFill=()=>{let z=document.querySelectorAll('.drop-zone');let ok=0;z.forEach(x=>{if(x.innerText===x.getAttribute('data-ans')){x.style.color="green";ok++;}else x.style.color="red";});if(ok===z.length)alert("¬°Excelente!");};
        function renderFlashcard(area) { if(currentStep >= currentGameData.length) currentStep=0; let item = currentGameData[currentStep]; area.innerHTML = `<div style="text-align:center"><div class="flashcard" onclick="this.classList.toggle('flipped')"><div class="flashcard-inner"><div class="flashcard-face f-front">${item.q}</div><div class="flashcard-face f-back">${item.a}</div></div></div><button class="btn-start" style="width:150px; margin:30px auto" onclick="currentStep++; renderFlashcard(document.getElementById('playerArea'))">Siguiente</button></div>`; }

        function startTimer() { let t=10; const b=document.getElementById('btnExam'); b.className='btn-exam'; b.disabled=true; clearInterval(timerInterval); timerInterval = setInterval(()=>{ b.innerHTML=`<i class="fas fa-clock"></i> Espera ${t}s...`; t--; if(t<0){clearInterval(timerInterval);b.disabled=false;b.className='btn-exam ready';b.innerHTML='Realizar Examen';b.onclick=showExam;} },1000); }
        async function loadExam(t) { let f=new FormData(); f.append('action','getExam'); f.append('Curso',t); let r=await fetch(API_URL,{method:'POST',body:f}); let d=await r.json(); examQuestions=d.data; }
        function showExam() { 
            const area = document.getElementById('playerArea'); document.getElementById('videoFooter').style.display='none'; area.className = 'modal-content-area game-mode';
            if(!examQuestions.length) { area.innerHTML='<h3 style="color:#999">Sin preguntas.</h3>'; return; }
            let h = `<div style="width:100%; max-width:700px; padding:20px; margin:0 auto;">`;
            examQuestions.forEach((q,i)=>{ 
                let ptsTag = q.puntaje ? `<small style="color:var(--primary); font-weight:bold">(${q.puntaje} pts)</small>` : '';
                h+=`<div style="background:white; padding:20px; border-radius:15px; margin-bottom:15px; box-shadow:0 4px 10px rgba(0,0,0,0.05)"><h4 style="margin-bottom:15px; color:var(--text-dark)">${i+1}. ${q.pregunta} ${ptsTag}</h4><label style="display:block; padding:10px; cursor:pointer;"><input type="radio" name="q${i}" value="op1"> ${q.opciones[0]}</label><label style="display:block; padding:10px; cursor:pointer;"><input type="radio" name="q${i}" value="op2"> ${q.opciones[1]}</label><label style="display:block; padding:10px; cursor:pointer;"><input type="radio" name="q${i}" value="op3"> ${q.opciones[2]}</label></div>`; 
            });
            h+=`<button class="btn-start" onclick="submitExam()">Enviar Examen</button></div>`;
            area.innerHTML = h;
        }
        function submitExam() {
            let pts=0, tot=0, res=[];
            examQuestions.forEach((q,i)=>{ 
                let p = q.puntaje ? parseInt(q.puntaje) : 1; tot += p;
                let o = document.querySelector(`input[name="q${i}"]:checked`); 
                let st = "INCORRECTO", txt="Sin respuesta";
                if(o) { txt=o.parentElement.innerText.trim(); if(o.value===q.correcta){pts+=p; st="CORRECTO";} }
                let pL = q.pregunta.replace(/;/g,",").replace(/\n/g," "); let rL = txt.replace(/;/g,",");
                res.push(`[P${i+1}: ${pL} | R: ${rL} (${st})]`);
            });
            let final = tot>0 ? Math.round((pts/tot)*20) : 0;
            alert('Nota: '+final+'/20');
            let fd=new FormData(); fd.append('action','saveGrade'); fd.append('Usuario',currentUser); fd.append('Curso',currentCourseTitle); fd.append('Nota',final); fd.append('Detalle',res.join(" ||| "));
            fetch(API_URL,{method:'POST',body:fd}).then(()=>{ closeModal(); loadRankingData(); });
        }

        function getYouTubeID(url) { if(!url) return null; const r = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/; const m = url.match(r); return (m && m[2].length === 11) ? m[2] : null; }
        function closeModal() { 
            document.getElementById('mainModal').style.display='none'; 
            document.getElementById('playerArea').innerHTML=''; 
            clearInterval(timerInterval);
            if(duelInterval) clearInterval(duelInterval);
        }
    </script>
</body>
</html>